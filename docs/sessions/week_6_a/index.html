<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 6 (Thinking about updating data)</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css" as="style"><link rel="preload" href="/data-management-2021-notes/assets/js/app.a6218cd0.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/2.3c4de620.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/12.25f6e0ab.js" as="script"><link rel="prefetch" href="/data-management-2021-notes/assets/js/10.b974fcf3.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/11.171587da.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/13.f1848b42.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/14.1695e155.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/15.8ff81293.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/16.e625795a.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/3.3730c6e1.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/4.8dbe0c5c.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/5.3fe88dbe.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/6.5aa88d7e.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/7.58ce105a.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/8.87c3beda.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/9.6a381137.js">
    <link rel="stylesheet" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/data-management-2021-notes/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Overview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 1 - Introduction to NodeJS and MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 2 - Exploring Node, Express and Templates</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 3 - MongoDB Queries</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 4  - Completing the MVC stack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 5 - Getting to Grips With the Assessment</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Week 6 - Thinking About Updating Data</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/data-management-2021-notes/sessions/week_6_a/" class="active sidebar-link">Week 6 (Thinking about updating data)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#thinking-about-theory" class="sidebar-link">Thinking About Theory</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#the-idea-of-consistency" class="sidebar-link">The Idea of Consistency</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#practical" class="sidebar-link">Practical</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#handling-a-form-post-request" class="sidebar-link">Handling a Form Post Request</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#task-1-implement-the-create-the-taster-route" class="sidebar-link">Task 1 -  Implement the Create the Taster Route</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#creating-a-new-document-using-mongoose" class="sidebar-link">Creating a New Document Using Mongoose</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#task-2-creating-a-new-taster" class="sidebar-link">Task 2 - Creating a New Taster</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#validating-our-taster" class="sidebar-link">Validating our Taster</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#task-3-validate-the-wine-tasters" class="sidebar-link">Task 3 - Validate the Wine Tasters</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#updating-data" class="sidebar-link">Updating Data</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_6_a/#task-4-update-the-tasters" class="sidebar-link">Task 4 - Update the Tasters</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 7 - Data Modeling and Relationships</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 8 - User Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 9 - Deploying to a Serverless Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 10 - Further Mongo Relations and Dynamic JavaScript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="week-6-thinking-about-updating-data"><a href="#week-6-thinking-about-updating-data" aria-hidden="true" class="header-anchor">#</a> Week 6 (Thinking about updating data)</h1> <div class="tip custom-block"><p><strong>session dependencies</strong></p> <p>You will need to make sure you are up-to-date with the tasks from week-4. You can find the solutions to these tasks on, a &quot;week-4-solutions&quot; branch of the &quot;db-stater-project&quot; GitHub repository.</p> <p>You can clone the solution branch with the following terminal command:</p> <p><code>git clone https://github.com/joeappleton18/db-starter-project.git --single-branch --branch week-4-solutions</code></p> <p><strong>It's up to you how you used the solutions. Some may want to check their attempt and compare. While others, may clone the solutions each week - starting a blank with a blank slate.</strong></p></div> <p>This week, we are going to complete CRUD operations.</p> <p>Recall, <a href="https://social-annotations-development.web.app/week-4" target="_blank" rel="noopener noreferrer">in week-4<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, we looked how to (R)ead and (D)elete data. This week, we will be completing the  CRUD acronym by looking at (U)pdate and (D)elete.</p> <p>We will be addressing the key question:</p> <p><strong>How can I add/update data to a MongoDB database whilst maintaining data consistency?</strong></p> <p>We will answer the above question by firstly thinking about what it means for data to be consistent. Next, we will
move on to complete the create and update operations with the idea of data consistency in mind.</p> <h2 id="thinking-about-theory"><a href="#thinking-about-theory" aria-hidden="true" class="header-anchor">#</a> Thinking About Theory</h2> <p>As second-year university students, it is important to appreciate that you are not accessed on your ability to use technology. Rather,  we want to see that you can understand and rationalise about the use of technology.  As such, on a weekly basis, we will be considering and discussing key concepts. These concepts will guide you in justifying what type of database you choose. Importantly, you will be able to use these discussions to help with your assessment write up.</p> <h2 id="the-idea-of-consistency"><a href="#the-idea-of-consistency" aria-hidden="true" class="header-anchor">#</a> The Idea of Consistency</h2> <p>You would have heard me say &quot;non-relational databases are not as consistent as their relational counterparts&quot;.  Yet, what do I actually mean by this idea of consistency? Moreover, to what extent does it matter if our NoSQL MongoDB is not as consistent as its relational equivalent?</p> <p>To ensure data consistency, historically, relational databases have abided to a principle known as ACID (Atomicity, Consistency, Isolation, Durability ). ACID is, in effect, a set of of properties that guarantees the validity and consistency of data despite system mishaps and errors. It achieves this through requiring database transaction to be treated as a single unit that either succeeds fo fails.</p> <p>A transaction can be considered a sequence of database operations. The classic example is a banking system that is managing the transfer of funds between two accounts. In this example, we may need to conduct the following operations in sequence:</p> <ul><li>Begin Transaction
<ul><li>Debit Savings Account</li> <li>Credit Current Account</li> <li>Record in Transaction Journal</li></ul></li> <li>End Transaction</li></ul> <p>A database that supports ACID transactions will ensure that all of the above operations succeed; or, the database is rolled back to its state before the transaction began. As you can imagine, for a business or safety critical system this is vitally important. However, many NOSQL database do not, or only partially, support ACID transactions. <a href="https://www.mongodb.com/blog/post/mongodb-multi-document-acid-transactions-general-availability" target="_blank" rel="noopener noreferrer">For instance, MongoDB has only recently started supporting ACID transactions across multiple documents<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <br> <img src="/images/sql-vs-no-sql-updates.png"> <blockquote><blockquote><p>Can you see how we can reduce the transactions on a simple account management section of an application</p></blockquote></blockquote> <p>The developers of MongoDB (biased I know), argue that we have &quot; been conditioned by 40 years of relational data modeling to assume multi-document transactions are a requirement for any database&quot;. [They go on to suggest that, due to fundamental differences in the NoSQL data models up to 90% of the time we do not need the complexity of multi-document transactions](https://www.mongodb.com/blog/post mongodb-multi-document-acid-transactions-general-availability). Such an idea, is in direct opposition, to a relational approach, where most of the time we would need to consider using transactions. The above diagram highlights this idea, how different data modelling approaches reduce the amount of transactions across a like data set</p> <h3 id="references"><a href="#references" aria-hidden="true" class="header-anchor">#</a> References</h3> <p>Truica, C.O., Boicea, A. and Trifan, I., 2013, August. CRUD operations in MongoDB. In 2013 International Conference on Advanced Computer Science and Electronics Information (ICACSEI 2013). Atlantis Press.
Keep, M. and Cabral, A. (2018). MongoDB 4 Update: Multi-Document ACID Transactions | MongoDB Blog. [online] MongoDB. Available at: <a href="https://www.mongodb.com/blog/post/mongodb-multi-document-acid-transactions-general-availability" target="_blank" rel="noopener noreferrer">https://www.mongodb.com/blog/post/mongodb-multi-document-acid-transactions-general-availability<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> [Accessed 9 Nov. 2020].</p> <h2 id="practical"><a href="#practical" aria-hidden="true" class="header-anchor">#</a> Practical</h2> <p><strong>Before your start</strong>, ensure you have the latest version of our ongoing class project.</p> <img src="{entireWebStack}/"> <blockquote><blockquote><p>The classical MVC model in the context of browser communication. Notice how we facilitate updates through HTTP requests</p></blockquote></blockquote> <p>This week is very special, as we are going to complete the MVC stack. In doing so, you are going to be able to add and update wine tasters 🍷🏭. Updating/Adding, wine tastings is a little more involved and we will look at that next week.</p> <h2 id="handling-a-form-post-request"><a href="#handling-a-form-post-request" aria-hidden="true" class="header-anchor">#</a> Handling a Form Post Request</h2> <p>In order to update our database, we need to allow users to enter data into our application.</p> <p>The primary data transfer interface between the user and most web applications is, of course, a form. While there are many HTTP requests, a web form only facilitates two (GET and POST). <a href="https://github.com/expressjs/method-override" target="_blank" rel="noopener noreferrer">There are ways to, effectively, forward a POST request on to a different type of request (e.g. PUT)<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. However, for our wine tasting application, this may be overkill.</p> <p>Consider the ejs file, <code>views/create-taster.ejs</code>, you'll see I've created a form for you. Notice the key properties that allow us to communicate with the server (method, action, name):</p> <div class="language-html extra-class"><pre class="language-html"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/create-taster<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
       ... 
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
                  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-control<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Enter Name<span class="token punctuation">&quot;</span></span>
        <span class="token punctuation">/&gt;</span></span>

       ...
        
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><blockquote><blockquote><p>views/update-taster.ejs</p></blockquote></blockquote> <p>Above, when a user submits a form, we tell the browser to construct a post request, <code>method=&quot;POST&quot;</code>. Send that request to our &quot;currenturl/create-taster&quot;, <code>action=&quot;/create-taster&quot;</code>. Finally, we use the name attribute to bind the value of each input to a distinctive name for later server access. Express makes it very simple to trigger a function when a POST request is sent to the server:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/create-taster&quot;</span><span class="token punctuation">,</span> tasterController<span class="token punctuation">.</span>create<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><blockquote><blockquote><p>Express provides handlers for all http requests</p></blockquote></blockquote> <h2 id="task-1-implement-the-create-the-taster-route"><a href="#task-1-implement-the-create-the-taster-route" aria-hidden="true" class="header-anchor">#</a> Task 1 -  Implement the Create the Taster Route</h2> <p>While we have a create-taster view set up, there is currently no route, let's fix this:</p> <ul><li><p>We don't really need a dedicated controller just to display the form. Add a new <code>/create-taster</code> route in <code>app.js</code> that renders our <code>create-taster</code> view. You should now be able to view the route <code>&lt;your host&gt;/create-taster</code>. Next, you should update the link on the create taster button in <code>tasters.ejs</code>, it should link to your new view.</p></li> <li><p>Within <code>controllers/taster.js</code> construct a function to handle our posted form data. For now, we will just log the post req to our console.</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;done&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>Create a rout in <code>app.js</code> that passes our new function to a post request that is sent to <code>/create-taster</code>.  If all has gone well, you should see the request logged to your console (the terminal window where you ran you application) when you submit the form. However, it does not look like there is any form data in there!?</p></li> <li><p>We need to add, what's know as middleware, to process our incoming HTTP requests and append the post data to these requests before they hit our controllers. We can use the, <a href="https://www.npmjs.com/package/body-parser#bodyparserrawoptions" target="_blank" rel="noopener noreferrer">body-parser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> package to achieve this.</p> <ul><li>Install it <code>npm install body-parser</code></li> <li>Require it, at the top of <code>app.js</code>  -  <code>var bodyParser = require('body-parser')</code></li> <li>Finally, we need to instruct express to use it. In <code>app.js</code>, insert the following code:</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>bodyParser<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span> extended<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre></div></li> <li><p>If you now submit the create taster form you should see that the form values are included in the request:</p></li></ul> <div class="language-js extra-class"><pre class="language-js"><code>    body<span class="token punctuation">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">:</span> <span class="token keyword">null</span> prototype<span class="token punctuation">]</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'foo'</span><span class="token punctuation">,</span> twitter<span class="token punctuation">:</span> <span class="token string">'barr'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><ul><li>You can access each form value by using the standard dot notation, <code>req.body.name</code> and <code>req.body.twitter</code></li></ul> <h2 id="creating-a-new-document-using-mongoose"><a href="#creating-a-new-document-using-mongoose" aria-hidden="true" class="header-anchor">#</a> Creating a New Document Using Mongoose</h2> <p>Let's move on  to consider how we might create a new document using a Mongoose Model. We shall explore this idea through extending our <code>controllers/taster.js</code> create operation.</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>   
   <span class="token keyword">let</span> taster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Taster</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">,</span> twitter<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>twitter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> taster<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/tasters/?message=taster has been created'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p><code>controllers/taster.js</code> , a controller operation to create a new taster</p></blockquote></blockquote> <p>Above, we first use our model to initiate a new document object and save it to the const taster (l.1). Next, to create a new record in our database, we call the aysnc operation <code>taster.save()</code>. Finally, we redirect back to our list of tasters.</p> <h2 id="task-2-creating-a-new-taster"><a href="#task-2-creating-a-new-taster" aria-hidden="true" class="header-anchor">#</a> Task 2 - Creating a New Taster</h2> <ul><li><p>Use the documentation above to update your project so you can create new tasters.</p></li> <li><p>Notice, in the above create taster example, we use a query string to append a message to the URL that should be displayed to the user - <code>res.redirect('/tasters/?message=taster has been created')</code>. Can you set up a basic user alert that displays the message when the use gets redirected to /tasters/.</p> <ul><li><a href="https://getbootstrap.com/docs/4.0/components/alerts/" target="_blank" rel="noopener noreferrer">Bootstrap has a range of different alerts you can use<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Recall, express allows us to grab query string values from a request -  <code>const message = req.query.message;</code></li></ul></li> <li><p>If all has gone well, you should now be able update a record. While at the same time receiving basic user feedback. While we are not going for any design awards her, like your assessment should be, the application is functional.</p></li></ul> <h2 id="validating-our-taster"><a href="#validating-our-taster" aria-hidden="true" class="header-anchor">#</a> Validating our Taster</h2> <p>While we have the functionality to add a new tasters. We are still not conforming to the C in ACID, which dictates:</p> <blockquote><blockquote><p>&quot;all data will be consistent. All data will be valid according to all defined rules, including any constraints, cascades, and triggers that have been applied on the database.&quot;</p></blockquote></blockquote> <p>Currently, we only have some basic schema definitions in <code>models/Taster.js</code>. While this is better than nothing, we could still create a new taster with no name, or enter any random string value for their twitter address. This means, our data may not be consistent or valid 😱  This is, of course, not ACID compliant or a sensible approach to database development. <a href="https://mongoosejs.com/docs/validation.html" target="_blank" rel="noopener noreferrer">Luckily, Mongoose affords us a very robust set of validators<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>! Let's consider how we could start adding some basic validation to our <code>models/Taster.js</code> model.</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token operator">=</span> mongoose<span class="token punctuation">;</span>

<span class="token keyword">const</span> tasterSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    twitter<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    tastings<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> Number<span class="token punctuation">,</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'Name is required'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> minlength<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&quot;Name must be 4 chars long&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Taster&quot;</span><span class="token punctuation">,</span> tasterSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><blockquote><p><code>models/Taster.js</code> - we've added some basic validation</p></blockquote></blockquote> <br> <p>Look, above, how easy it is to add validation and further properties to enhance data validity? Notice how we can expand each property on schema object to contain further constraints. For instance, 'tastings' must be Number and it has a default value of 0 (l.7); recall, it contains the number of tastings a taster has conducted. Next, consider 'name', it is required and has a minlength (l.8). Notice the arrays which set the validator and then contain a custom error message, this is very handy for user feedback. Mongoose has the following built in validators:</p> <ul><li>All SchemaTypes have the built-in <code>required</code> validator.</li> <li>Numbers have <code>min</code> and <code>max</code> validators.</li> <li>Strings have enum, match, <code>minlength</code>, and <code>maxlength</code> validators.</li></ul> <p>You can also use a <code>unique</code> option. This is not a validator, but rather a helper for creating MongoDB unique indexes. You should note, according to the <a href="https://docs.mongodb.com/manual/core/index-unique/" target="_blank" rel="noopener noreferrer">MongoDB documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, 'MongoDB cannot create a unique index on the specified index field(s) if the collection already contains data that would violate the unique constraint for the index'.</p> <h3 id="handling-and-displaying-errors"><a href="#handling-and-displaying-errors" aria-hidden="true" class="header-anchor">#</a> Handling and Displaying errors</h3> <p>We are now validating our taster form data; however, we are not displaying any meaningful feedback to the user - let's address this.</p> <p>When we try and save a model, if it does not validate, mongoose will throw an exception which includes the validation error messages in an error property. All we need to do is catch this error and make the error messages available to our <code>create-taster</code> view. We can then display the errors to the user.</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>
exports<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> taster <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Taster</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">,</span> twitter<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>twitter <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> taster<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/tasters/?message=taster has been created'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'create-taster'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> errors<span class="token punctuation">:</span> e<span class="token punctuation">.</span>errors <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><blockquote><p>controllers/taster.js - we catch and inject the error object into our create-taster view</p></blockquote></blockquote> <p>Above, we capture validation errors and pass the errors to the 'create-taster' view. We are making an errors object available to this view so we can display them to our user (l.10). There is a slight gotcha here, we are only making an errors object available to our view if an error occurs. This makes things a little tricky as this object wont be available in our standard view and evaluating it will cause an error (how ironic). To fix this issue, let's update our create-taser route to contain an empty errors object:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/create-taster&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;create-taster&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><blockquote><p>app.js - above we mock out a empty errors object, this makes our lives a little easier.</p></blockquote></blockquote> <p>We can now, within <code>views/create-taster.ejs</code>, evaluate the errors object and display any error messages to the user.</p> <div class="language-html extra-class"><pre class="language-html"><code>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span><span class="token punctuation">&gt;</span></span> 

... 

  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-group<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Taster Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
                  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-control<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>name<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">placeholder</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>Enter Name<span class="token punctuation">&quot;</span></span>
                <span class="token punctuation">/&gt;</span></span>

                &lt;% if (errors['name']) { %&gt;
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token style-attr language-css"><span class="token attr-name"> <span class="token attr-name">style</span></span><span class="token punctuation">=&quot;</span><span class="token attr-value"><span class="token property">color</span><span class="token punctuation">:</span> red</span><span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>&lt;%= errors['name'].message %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
                &lt;% } %&gt;
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

...

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><blockquote><blockquote><p><code>views/create-taster.ejs</code> - Displaying an optional error message for our taster name</p></blockquote></blockquote> <p>Looking at the code above, you'd be forgiven for thinking our errors object is an array. After all, we are accessing, elements within it,  like this, <code>errors['name']</code>. However, this is not the case, we can use the square brackets syntax as a, dynamic, alternative to dot notation. In other words, <code>errors['name'] ==== errors.name</code>. It's necessary to use this alternative notation when accessing nested objects, as JS only allows a  <code>dot</code> in the context of EJS objects. Hencesingle, I've used this notation <code>errors['name'].message</code>.</p> <h2 id="task-3-validate-the-wine-tasters"><a href="#task-3-validate-the-wine-tasters" aria-hidden="true" class="header-anchor">#</a> Task 3 - Validate the Wine Tasters</h2> <ul><li>Add basic validation to your taster model. For instance, the name should be required and some chosen min length</li> <li>Work out how to add a custom <a href="https://mongoosejs.com/docs/validation.html#custom-validators" target="_blank" rel="noopener noreferrer">validator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to validate if a user has entered a valid twitter handle.  <a href="https://stackoverflow.com/questions/8650007/regular-expression-for-twitter-username" target="_blank" rel="noopener noreferrer">Hint, use a regx within the custom validator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Construct error messages in your taster's model validators and displays these errors if they try to create an erroneous taster.</li></ul> <h2 id="updating-data"><a href="#updating-data" aria-hidden="true" class="header-anchor">#</a> Updating Data</h2> <p>Let's bring this weeks learning to a close by considering how we might add the functionality to update our wine tasters. Rather than walk you through the exact solution, I am going to give you some tips and let you work out the granular details yourself.</p> <p>First, let's think about how this process is going to work:</p> <ol><li><p>A user visits, <code>/tasters</code> and sees a list of tasters. They click the edit button, for any given taster, and are redirected to a url that conforms to the following format <code>tasters/update/5f9ac08e4d0e84e15e7c50f7</code>. Where the long string, is the id of the taster we want to update.
You've seen how we have achieved similar functionality for our delete route.</p></li> <li><p>We need to find the taster by the id param that is contained in the url, and throw a 404 error if the given taster does not exist. You can use the <code>findById</code> method to achieve this <code>const taster = await Taster.findById(id);</code></p></li> <li><p>We need to insert the information of the taster we want to edit into our form. This is actually very easy:</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code>            <span class="token operator">&lt;</span>input
                  value<span class="token operator">=</span><span class="token string">&quot;&lt;%= taster.name %&gt;&quot;</span>
                  type<span class="token operator">=</span><span class="token string">&quot;text&quot;</span>
                  <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-control&quot;</span>
                  id<span class="token operator">=</span><span class="token string">&quot;name&quot;</span>
                  name<span class="token operator">=</span><span class="token string">&quot;name&quot;</span>
                  placeholder<span class="token operator">=</span><span class="token string">&quot;Enter Name&quot;</span>
                <span class="token operator">/</span><span class="token operator">&gt;</span>

</code></pre></div><blockquote><blockquote><p>An example of how we can set the value of a form field, according to values provided by our server side code.</p></blockquote></blockquote> <p>Finally, we need to consider how we can validate the form, and update a taster. Very similar to what we did for creation; however, we can use the, <code>Taster.updateOne({ _id: id }, req.body);</code> method instead of create.</p> <h2 id="task-4-update-the-tasters"><a href="#task-4-update-the-tasters" aria-hidden="true" class="header-anchor">#</a> Task 4 - Update the Tasters</h2> <p>Follow the hints above and add the functionality that allows tasters to be updated. <a href="https://github.com/joeappleton18/db-starter-project/tree/week-6-solutions" target="_blank" rel="noopener noreferrer">If you need any help, you can find my solutions on a week-6 branch of our ongoing project<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/data-management-2021-notes/sessions/week_5/" class="prev">Week 5 (Getting to Grips With the Assessment)</a></span> <span class="next"><a href="/data-management-2021-notes/sessions/week_7/">Week 7 (Data Modeling and Relationships)</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/data-management-2021-notes/assets/js/app.a6218cd0.js" defer></script><script src="/data-management-2021-notes/assets/js/2.3c4de620.js" defer></script><script src="/data-management-2021-notes/assets/js/12.25f6e0ab.js" defer></script>
  </body>
</html>
