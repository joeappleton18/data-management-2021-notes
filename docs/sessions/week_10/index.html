<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 10 (Further Mongo Relations and Dynamic JavaScript)</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css" as="style"><link rel="preload" href="/data-management-2021-notes/assets/js/app.a6218cd0.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/2.3c4de620.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/7.58ce105a.js" as="script"><link rel="prefetch" href="/data-management-2021-notes/assets/js/10.b974fcf3.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/11.171587da.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/12.25f6e0ab.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/13.f1848b42.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/14.1695e155.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/15.8ff81293.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/16.e625795a.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/3.3730c6e1.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/4.8dbe0c5c.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/5.3fe88dbe.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/6.5aa88d7e.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/8.87c3beda.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/9.6a381137.js">
    <link rel="stylesheet" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/data-management-2021-notes/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Overview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 1 - Introduction to NodeJS and MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 2 - Exploring Node, Express and Templates</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 3 - MongoDB Queries</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 4  - Completing the MVC stack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 5 - Getting to Grips With the Assessment</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 6 - Thinking About Updating Data</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 7 - Data Modeling and Relationships</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 8 - User Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 9 - Deploying to a Serverless Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Week 10 - Further Mongo Relations and Dynamic JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/data-management-2021-notes/sessions/week_10/" class="active sidebar-link">Week 10 (Further Mongo Relations and Dynamic JavaScript)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#our-current-client-server-model" class="sidebar-link">Our Current Client Server Model</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#the-clunky-web-site-problem" class="sidebar-link">The clunky web-site problem</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#what-is-ajax" class="sidebar-link">What is AJAX?</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#constructing-an-ajax-request" class="sidebar-link">Constructing an AJAX Request</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#text-search" class="sidebar-link">Text search</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#practical-session" class="sidebar-link">Practical Session</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#linking-javascript-to-our-ejs-templates" class="sidebar-link">Linking JavaScript to Our EJS Templates</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#task-1-linking-in-javascript-files" class="sidebar-link">Task 1 - Linking in JavaScript files</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#setting-up-a-basic-api" class="sidebar-link">Setting up a basic API</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#task-2-set-up-the-search-tasting-api-route" class="sidebar-link">Task 2 - Set up the search tasting API route</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#consuming-our-api" class="sidebar-link">Consuming our API</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#task-3-set-up-the-search-tasting-api-route" class="sidebar-link">Task 3 - Set up the search tasting API route</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#favorite-wine-tastings" class="sidebar-link">Favorite Wine Tastings</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#task-4-set-up-save-tastings" class="sidebar-link">Task 4 - Set up Save Tastings</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#task-5-remove-saved-tastings" class="sidebar-link">Task 5 - Remove Saved Tastings</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_10/#task-6-is-authenticated-api" class="sidebar-link">Task 6 - Is Authenticated API</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="week-10-further-mongo-relations-and-dynamic-javascript"><a href="#week-10-further-mongo-relations-and-dynamic-javascript" aria-hidden="true" class="header-anchor">#</a> Week 10 (Further Mongo Relations and Dynamic JavaScript)</h1> <div class="tip custom-block"><p><strong>Session Dependencies</strong></p> <p>This week we are continuing with our wine tasting theme. Please ensure you have the latest version of the project</p> <p>You can clone this version using the following command:</p> <ul><li><code>git clone https://github.com/joeappleton18/db-starter-project.git --single-branch --branch week-9-solutions</code></li></ul> <p>This week we will be working in development mode. As such, set up your <code>.env</code> file to point to your local MongoDB setup.</p> <p><strong>Note</strong>, you might get an error stating &quot;incompatible node environment&quot;. This can be fixed by grabbing your version of node, <code>node -v</code> then updating the engines property in the <code>package.json</code> file to your version of node.</p></div> <p>Last week](/week-9), in deploying our application, concluded our exploration of the fundamental JavaScript technologies needed to create a data-driven web application. This week I want us to consider, for lack of a better term, how we can make our wine application a little less clunky. As such, we will be exploring the following questions:</p> <h3 id="how-can-i-introduce-front-end-javascript-into-my-application-to-allow-for-database-updates-without-the-need-for-the-browser-to-reload-the-page"><a href="#how-can-i-introduce-front-end-javascript-into-my-application-to-allow-for-database-updates-without-the-need-for-the-browser-to-reload-the-page" aria-hidden="true" class="header-anchor">#</a> How can I introduce front-end JavaScript into my application to allow for database updates without the need for the browser to reload the page?</h3> <h3 id="how-can-i-take-the-idea-of-mongodb-relations-further-to-allow-users-to-favourite-wine-tastings-a-fun-little-feature"><a href="#how-can-i-take-the-idea-of-mongodb-relations-further-to-allow-users-to-favourite-wine-tastings-a-fun-little-feature" aria-hidden="true" class="header-anchor">#</a> How can I take the idea of MongoDB relations further to allow users to favourite wine tastings (a fun little feature)?</h3> <h2 id="our-current-client-server-model"><a href="#our-current-client-server-model" aria-hidden="true" class="header-anchor">#</a> Our Current Client Server Model</h2> <img src="/images/entire-request.png"> <blockquote><blockquote><p>The architecture of our web application</p></blockquote></blockquote> <h2 id="the-clunky-web-site-problem"><a href="#the-clunky-web-site-problem" aria-hidden="true" class="header-anchor">#</a> The clunky web-site problem</h2> <p>We have implemented the classic three-tier architecture (client tier, app tier, and database tier).</p> <p>Our application, from the prospective of the user is fairly static. A user, via a browser, visits a given URL issuing a HTTP GET request, or issues a POST/GET request via submitting a form.  Our application layer then pattern matches the path requested and deploys a corresponding controller. For instance, when a browser makes a request to our home page,<code>/</code>, we serve up our home controller: <code>app.get(&quot;/&quot;, homeController.list);</code>. Our home controller then interfaces with the database, constructs an html page and sends this page, and its associated files (e.g. album.css), back to the browser issuing the request. The reason why our website is currently a little clunky is the only way we can currently update our html views is for the users to issue another request, and each time our browser reloads the page and its associated assets. This is fine, for mostly static content (e.g., the wine tasting home page); however, for things like search, pagination, favoriting wine tastings - things become a little painful. Why should I have to reload the entire page to add a wine tasting to my favorites list!? To solve this problem, we need to allow the browser to communicate with our application layer without needing to refresh.   <strong>The solution is AJAX</strong></p> <h2 id="what-is-ajax"><a href="#what-is-ajax" aria-hidden="true" class="header-anchor">#</a> What is AJAX?</h2> <p>AJAX stands for Asynchronous JavaScript And XML. It is a method of using the the browsers 'XMLHttpRequest object' to construct client-server communication. Crucially, it allows us to complete this process <strong>without</strong> the need to refresh the web-page.</p> <h2 id="constructing-an-ajax-request"><a href="#constructing-an-ajax-request" aria-hidden="true" class="header-anchor">#</a> Constructing an AJAX Request</h2> <p><a href="https://developer.mozilla.org/en-US/docs/Web/Guide/AJAX" target="_blank" rel="noopener noreferrer">We use client-side JavaScript to implement an AJAX request, and it used to be painful<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Because of this, people would use libraries such as <code>jQuery.ajax()</code> to simply the process. However, in recent times,  HTML-5 has implemented a much more intuitive <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch" target="_blank" rel="noopener noreferrer">Fetch API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <p>:::</p> <p><strong>key point</strong></p> <p>Client-side JavaScript in called client-side because it is executed in the browser as opposed to on our server. As it's run in the browser, it can not access server-side code (e.g., our models and controllers).</p> <p>:::</p> <p>Let's consider a very simple example of how we could use the <code>Fetch Api</code> to update an HTML page without the need to refresh:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">handleGetClick</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> userRef <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://randomuser.me/api/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userRef<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#user'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;user&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span> 
    <span class="token operator">&lt;</span>button onclick<span class="token operator">=</span><span class="token string">&quot;handleGetClick()&quot;</span><span class="token operator">&gt;</span>Get me a user<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre></div><blockquote><blockquote><p>An example of a simple AJAX request using fetch to issue a get request</p></blockquote></blockquote> <p>Above, we set up an event handler on the button - <code>onclick=&quot;handleGetClick()</code>. This ties the function <code>handleGetClick()</code> to a button click event.</p> <p>When the button is clicked, we issue a get request to a free random API - <code>randomuser.me</code>. Notice how we receive the response and finally update our page with the results -  <code>document.querySelector('#user').innerHTML = JSON.stringify(user);</code>. All of this has been achieve without the need of a refresh! This allows us to turn clunky reloads into dynamic features.</p> <h2 id="text-search"><a href="#text-search" aria-hidden="true" class="header-anchor">#</a> Text search</h2> <p>Our second clunk issue is there is no real way to search our wine tastings that is natural to a user. For instance, as a discerning wine drinker, I might want to search for a cheap table wine. Currently there is no way to query the database with a natural search term such as, &quot;Table wine&quot;. Lucky for us, MongoDB comes with a text search feature that solves our problem.</p> <p>We can create a composite text index on Tastings that includes wine title and description and then conduct a search with &quot;Table wine&quot;. MongoDB will return a list of all documents that contain the term &quot;Table wine&quot; in the description or title. We even get a similarity score based on how close the match is to our search term. While not an amazingly powerful search solution, we get this functionality out of the box - very nice!</p> <p>Let's consider a quick example that you can run from a <a href="https://code.visualstudio.com/docs/azure/mongodb" target="_blank" rel="noopener noreferrer">MongoDB playground<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'wine'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

db<span class="token punctuation">.</span>tastings<span class="token punctuation">.</span><span class="token function">createIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span>title<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span> description<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span>tastings<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
   <span class="token punctuation">{</span> $text<span class="token punctuation">:</span> <span class="token punctuation">{</span> $search<span class="token punctuation">:</span> <span class="token string">&quot;/Table Wine/&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token punctuation">{</span> score<span class="token punctuation">:</span> <span class="token punctuation">{</span> $meta<span class="token punctuation">:</span> <span class="token string">&quot;textScore&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> score<span class="token punctuation">:</span> <span class="token punctuation">{</span> $meta<span class="token punctuation">:</span> <span class="token string">&quot;textScore&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span>
</code></pre></div><blockquote><blockquote><p>Performing natural text search</p></blockquote></blockquote> <p>Above, we first set up a text index on tastings, <code>db.tastings.createIndex({title: 'text', description: 'text'});</code>.  Text indexes can include any field whose value is a string or an array of string elements. You should note that a collection can only have one text index. Next, we search the index, through using the <code>$text</code> operator. The two '//' means that we are looking for an exact match, it's a regular expression. On running this query, you'll notices that you'll get a list of matching wine tastings back</p> <p>So,in-order to declunk our web-application, we are going to combine AJAX and text search to create a modern user experience - let's dive in!</p> <h2 id="practical-session"><a href="#practical-session" aria-hidden="true" class="header-anchor">#</a> Practical Session</h2> <p>First, ensure that you have the latest version of our wine tasting app (see session dependencies). On running this project, you'll notice that I've set up a search page for you (visit <code>/search-tastings</code>). Surprisingly, this search page does not work. All we are doing is serving the static EJS file, <code>views/search-tastings.ejs</code>.</p> <h2 id="linking-javascript-to-our-ejs-templates"><a href="#linking-javascript-to-our-ejs-templates" aria-hidden="true" class="header-anchor">#</a> Linking JavaScript to Our EJS Templates</h2> <p>Our first step in getting our search to work, is to bind a JavaScript function to the page's button click event. We can do this as follows:</p> <div class="language-html extra-class"><pre class="language-html"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>handleClick()<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn btn-outline-secondary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>button<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                        🍷 Search Wine Tastings 🍷
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><blockquote><blockquote><p><code>views/search-tastings.ejs</code>, binding the function <code>handleClick</code> to our wine search</p></blockquote></blockquote> <p>If you refresh your search page and click the button you should get the following error in your browsers console (open developer tools to see this), <code>Uncaught ReferenceError: handleClick is not defined at HTMLButtonElement.onclick</code>. We get this error as the browser is looking for a <code>handleClick</code> function, but we have not defined one yet. However, where should we place our client side JavaScript? - remember we don't want to mix server and client side concerns.</p> <p>Recall, we are using the express static middleware in app.js, <code>app.use(express.static(path.join(__dirname, &quot;public&quot;)));</code>.  This, allows us to server static content to the browser from the <code>public</code> directory in the root of our project. This is where all static content should go, including client-side JavaScript. Let's set up a function to handle our click event:</p> <ul><li>Create, <code>public/scripts/search-tasting.js</code>, and add a handler function:</li></ul> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'search button clicked'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p><code>public/scripts/search-tasting.js</code></p></blockquote></blockquote> <ul><li>Finally, we need to link our <code>search-tasting.js</code> file to our <code>search-tastings.ejs</code> page.</li></ul> <p>We can do this is the normal way:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token operator">...</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>script src<span class="token operator">=</span><span class="token string">&quot;scripts/search-tasting.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">...</span>
</code></pre></div><p><code>views/search-tastings.ejs</code></p> <ul><li>If all has gone well, when you click the search button you should now see 'search button clicked' in the browser console.</li></ul> <h2 id="task-1-linking-in-javascript-files"><a href="#task-1-linking-in-javascript-files" aria-hidden="true" class="header-anchor">#</a> Task 1 - Linking in JavaScript files</h2> <p>Follow the steps above to link the <code>search-tasting</code> JavaScript file into your search page.</p> <h2 id="setting-up-a-basic-api"><a href="#setting-up-a-basic-api" aria-hidden="true" class="header-anchor">#</a> Setting up a basic API</h2> <p>In order to allow a browser to search our application via an AJAX request we need to do two things:</p> <ol><li>Set up a text index on tastings</li> <li>Expose an API route to allow the browser to send search terms that will be used to query this index</li></ol> <p>First, we need to update our Tastings schema so that it instructs MongoDB to create a text index on our tastings collection:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token operator">...</span>
tastingSchema<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'$**'</span><span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Tasting&quot;</span><span class="token punctuation">,</span> tastingSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>

</code></pre></div><blockquote><blockquote><p><code>models/Tasting.js</code>, <code>tastingSchema.index({'$**': 'text'});</code> creates a composite text index across all text fields in our tastings collection - a extreme I know. However, I wanted to show off this feature. In the notes above, I demonstrated how we could be a little more selective.</p></blockquote></blockquote> <p>That was simple, we've completed step 1. Now, we just need to create some API routes. We already know how to create routes. We just need to think what API routes paths should look like and where the controllers should live. I like to pre-append my api routes with <code>api</code>. As such, <code>/api/search-tastings</code> seems like a good choice. Finally, it's a good idea to place our API controllers into a controller sub-folder called api. Let's set all of this up:</p> <ul><li>Create the file <code>controllers/api/tasting.js</code> it should contain the following code:</li></ul> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>
exports<span class="token punctuation">.</span><span class="token function-variable function">list</span> <span class="token operator">=</span>  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">const</span> searchQuery <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>search<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>searchQuery<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> Result <span class="token operator">=</span>  <span class="token keyword">await</span> Tasting<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>
            <span class="token punctuation">{</span> $text<span class="token punctuation">:</span> <span class="token punctuation">{</span> $search<span class="token punctuation">:</span> searchQuery<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> score<span class="token punctuation">:</span> <span class="token punctuation">{</span> $meta<span class="token punctuation">:</span> <span class="token string">&quot;textScore&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
         <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span> <span class="token punctuation">{</span> score<span class="token punctuation">:</span> <span class="token punctuation">{</span> $meta<span class="token punctuation">:</span> <span class="token string">&quot;textScore&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">could not perform search</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p><code>controllers/api/tasting.js</code>, a simple controller function list</p></blockquote></blockquote> <p>The above code should be fairly familiar. <code>req.query.search;</code> will grab the search query string out of the url. Next, we are conducting a text search across out index, you should use the notes above to play around with exact and broad match queries. Finally, notice how we are not rendering any views. Rather, we just return the results in <code>JSON</code> format - <code>res.json(Result);</code>.</p> <p>Next, as usual, we need to link a route to this new controller function. In app.js insert the following code:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token operator">...</span>
    <span class="token keyword">const</span> tastingApiController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./controllers/api/tasting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
    app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/api/search-tastings&quot;</span><span class="token punctuation">,</span> tastingApiController<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>    
</code></pre></div><blockquote><blockquote><p>app.js, notice how we use tastingApiController to identify that this controller is for our api</p></blockquote></blockquote> <ul><li>If all has gone well, you can issue a request to the API by simply visiting 'http://localhost:your port/api/search-tastings?search=Table Wine'. You should see a raw JSON output.</li></ul> <h2 id="task-2-set-up-the-search-tasting-api-route"><a href="#task-2-set-up-the-search-tasting-api-route" aria-hidden="true" class="header-anchor">#</a> Task 2 - Set up the search tasting API route</h2> <p>Use the notes above to set up a functional <code>/api/search-tastings</code> route.</p> <h2 id="consuming-our-api"><a href="#consuming-our-api" aria-hidden="true" class="header-anchor">#</a> Consuming our API</h2> <p>We are nearly there, we just need to link the client side, <code>public/scripts/search-tasting.js</code>'s code to our api. This is not a web unit, so I am going to give you a whistle-stop tour of front end development. If you enjoy it, then you can take things further in the assessment. Also, you may want to consider taking my contemporary web application unit next year (it's a great unit 😉).</p> <p>First, take a look at <code>views/search-tastings.ejs</code>, notice that we have a empty div:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>         <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">&quot;wineItems&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
</code></pre></div><p><code>views/search-tastings.ejs</code>, an empty div</p> <p>The above empty div is where we inject our search results - such an approach is common. In fact, many large applications are injected into a div on a single HTML page. Let's consider how we can amend <code>public/scripts/search-tasting.js</code> to communicate with the api and inject the search results into  <code>&lt;div id=&quot;wineItems&quot;&gt;&lt;/div&gt;</code>:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">wineView</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">wine</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">

&lt;div class=&quot;col-12&quot;&gt;
    &lt;div class=&quot;card&quot;&gt;
        &lt;h5 class=&quot;card-header&quot;&gt; </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> &lt;strong&gt;(search match: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>score<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)&lt;/strong&gt;&lt;/h5&gt;
        &lt;div class=&quot;card-body&quot;&gt;
         &lt;p class=&quot;card-text&quot;&gt;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>description<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/p&gt;
          &lt;ul class=&quot;list-group&quot;&gt;
               &lt;li class=&quot;list-group-item&quot;&gt;Country: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>taster_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/li&gt;
                &lt;li class=&quot;list-group-item&quot;&gt;Country: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>country<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/li&gt;
                &lt;li class=&quot;list-group-item&quot;&gt;Designation: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>designation<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/li&gt;
                &lt;li class=&quot;list-group-item&quot;&gt;Points: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>points<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/li&gt;
                &lt;li class=&quot;list-group-item&quot;&gt;Price: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>price<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/li&gt;
                &lt;li class=&quot;list-group-item&quot;&gt;Province: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>province<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&lt;/li&gt;
          &lt;/ul&gt;
        &lt;/div&gt;
        &lt;a href=&quot;#&quot; class=&quot;btn btn-primary&quot;&gt;Save&lt;/a&gt;
      &lt;/div&gt;
 &lt;/div&gt;
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token function-variable function">handleClick</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> searchVal <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">&quot;#searchInput&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">const</span> wineDomRef <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#wineItems'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
       
        <span class="token keyword">const</span> ref <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/search-tastings/?search=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>searchVal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> searchResults <span class="token operator">=</span> <span class="token keyword">await</span> ref<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> wineHtml <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        searchResults<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">wine</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           wineHtml<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">wineView</span><span class="token punctuation">(</span>wine<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        wineDomRef<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> wineHtml<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'could not search api'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p><code>public/scripts/search-tasting.js</code>,  code to handle searching and displaying wine</p></blockquote></blockquote> <p>Above, we first use the query selector to grab the search value that has been input, <code>const searchVal = document.querySelector(&quot;#searchInput&quot;).value;</code>. The <code>#</code> on <code>#searchInput</code> means that we are instructing the querySelector to grab an element with the id searchInput (e.g. <code>&lt;input id=&quot;searchInput&quot;/&gt;</code>). Notice how we also use this technique to get access to our empty set of <code>div</code>'s where our tastings results will be inserted - <code>const wineDomRef = document.querySelector('#wineItems');</code>.  We then go ahead and send a search request to our API - <code>const ref = await fetch(</code>/api/search-tastings/?search=${searchVal}<code>);</code>.</p> <p>We then loop across each tasting in our result and pass it into a template that we created:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>searchResults<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">wine</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
           wineHtml<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">wineView</span><span class="token punctuation">(</span>wine<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><blockquote><p><code>public/scripts/search-tasting.js</code>, setting up an array of wine tasting results.</p></blockquote></blockquote> <p>Finally, we inject this array into our <code>wineDomRef</code> -   <code>wineDomRef.innerHTML = wineHtml.join(&quot;&quot;);</code>. I am using a little trick here, the <code>.join(&quot;&quot;)</code> removes the commas out of our array - otherwise your page would be peppered with commas.</p> <p>That's it!!! You should now have a, pretty sweet, text search functionality on your wine tasting application.</p> <h2 id="task-3-set-up-the-search-tasting-api-route"><a href="#task-3-set-up-the-search-tasting-api-route" aria-hidden="true" class="header-anchor">#</a> Task 3 - Set up the search tasting API route</h2> <p>Use the notes above to complete your search functionality.</p> <h2 id="favorite-wine-tastings"><a href="#favorite-wine-tastings" aria-hidden="true" class="header-anchor">#</a> Favorite Wine Tastings</h2> <p>Notice how there is a save button on our search results. The idea here is, a logged in user, should be able to click save and their chosen tasting is added to their favourites. Let's consider how we might set this functionality up.</p> <p>Recall, a few weeks back, <a href="week-7#relationships-in-nosql-theory-focus">when we talked about relationships</a>. This, in my book, calls for a one-to-few relationship:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token string">&quot;email&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;foo@barr.com&quot;</span><span class="token punctuation">,</span>
 <span class="token operator">...</span>
<span class="token string">&quot;saved_tastings&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;5faec0143e8ca3790295c50d&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;5faeb03d94fdc3790ca4c570&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;5faeb03d94fdc3790ca51c4e&quot;</span>
  <span class="token punctuation">]</span>
</code></pre></div><blockquote><blockquote><p>tasting document, a user can have many tastings. The id's in our array reference tasting documents</p></blockquote></blockquote> <p>Above is the relationship we intend to create. You could denormalise the data here and place things like wine title, along with the tasting id, in the array. However, I wanted to show a slightly different method.</p> <p>To achieve the above:</p> <ul><li>First, we need to tweak our user model to include a &quot;saved_tastings&quot; attribute:</li></ul> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>
<span class="token operator">...</span>
<span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
        email<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'email is required'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> unique<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'password is required'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        saved_tastings<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> ref<span class="token punctuation">:</span> <span class="token string">&quot;Tasting&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><blockquote><blockquote><p><code>models/User.js</code> - Setting up a 1 to few relationship with Tasting</p></blockquote></blockquote> <ul><li><p>Next, we'll set up an API route to allow the client side to dynamically save tastings.</p></li> <li><p>Create the controller - <code>controllers/api/savedTasting.js</code> and add the following code:</p></li></ul> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> User <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../../models/User&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> tastingId <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>tastingId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>  <span class="token operator">!</span>tastingId <span class="token operator">||</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userID<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>result<span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">:</span> req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userID<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>$push<span class="token punctuation">:</span><span class="token punctuation">{</span>saved_tastings<span class="token punctuation">:</span> tastingId<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>result<span class="token punctuation">:</span> <span class="token string">'error could not create a favourite'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


</code></pre></div><blockquote><blockquote><p><code>controllers/api/savedTasting.js</code>, a function to favourite a tasting - attributing that favourite to the logged in user.</p></blockquote></blockquote> <p>Above should mostly be familiar to you. However, notice how we use the the MongoDB <code>$push</code> operation to push the tasting id to our &quot;saved_tastings&quot; on our user document.</p> <ul><li>Let's extend our <code>public/scripts/search-tasting.js</code> script to allow a user to dynamically save a tasting.</li></ul> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">handleSave</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'/api/saved-tasting'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'application/json'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      body<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span> id<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token function-variable function">wineView</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">wine</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">

        ...
        &lt;a href=&quot;#&quot; class=&quot;btn btn-primary&quot; onclick=&quot;handleSave('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>wine<span class="token punctuation">.</span>_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')&quot;&gt;Save&lt;/a&gt;
       ... 
</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><blockquote><blockquote><p><code>public/scripts/search-tasting.js</code>, added functionality to save our wine tastings</p></blockquote></blockquote> <p>Notice above, we use a little trick where we dynamically pass the id of the tasting into our handler function <code>onclick=&quot;handleSave('${wine._id}')&quot;</code>. When a user clicks a button, the browser will now pass the associated tasting ID in for us - I like this little trick. Finally, notice how we used a post request to save our favourite. It's common practice to use a post when saving and get when searching.</p> <p>We are nearly there. A logged in use should be able to save a tasting. However, we need to allow the user to view their favourites. This does not need to be dynamic functionality as it's a fairly static operation. Let's finish things off and do this:</p> <p>Create the controller, <code>controllers/savedTasting.js</code> and add the following code:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>
exports<span class="token punctuation">.</span><span class="token function-variable function">list</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> userRef <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'saved_tastings'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'saved-tastings'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>tastings<span class="token punctuation">:</span> userRef<span class="token punctuation">.</span>saved_tastings<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>result<span class="token punctuation">:</span> <span class="token string">'could not find user faves'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p><code>controllers/savedTasting.js</code>, a one to few join</p></blockquote></blockquote> <p>Above, notice how we are using populate to populate our <code>saved_tastings</code> array containing id's with their actual tasting record. In other words, we get an array of tasting records, opposed to just their IDs. As I have already create the view '/views/saved-tastings.ejs', all we need to do now is set up a <code>/saved-tastings</code> route.</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code><span class="token operator">...</span>
<span class="token keyword">const</span> savedTastingApiController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./controllers/api/savedTasting&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/saved-tastings&quot;</span><span class="token punctuation">,</span> savedTastingController<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
</code></pre></div><blockquote><blockquote><p><code>app.js</code>, setting up a saved-tastings route</p></blockquote></blockquote> <p>That's it! We are done, you can now allow logged-in users to save wine tastings.</p> <h2 id="task-4-set-up-save-tastings"><a href="#task-4-set-up-save-tastings" aria-hidden="true" class="header-anchor">#</a> Task 4 - Set up Save Tastings</h2> <p>Using the notes above, extend your application so users can save tastings</p> <h2 id="task-5-remove-saved-tastings"><a href="#task-5-remove-saved-tastings" aria-hidden="true" class="header-anchor">#</a> Task 5 - Remove Saved Tastings</h2> <p>Can you add a delete button to each saved tastings. The user should be able to click the delete button, and without the browser refreshing, the tasting should be removed from their favourites.  You'll need to extend <code>controllers/api/savedTasting.js</code>, adding a delete method.</p> <h2 id="task-6-is-authenticated-api"><a href="#task-6-is-authenticated-api" aria-hidden="true" class="header-anchor">#</a> Task 6 - Is Authenticated API</h2> <p>Can you create a user API route that the front-end could use to determine if a user is authenticated (e.g., <code>controllers/api/user.js</code>). Next, use this information to hide the save button if the user is not logged-in.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/data-management-2021-notes/sessions/week_9/" class="prev">Week 9 (Deploying to a Serverless Infrastructure)</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/data-management-2021-notes/assets/js/app.a6218cd0.js" defer></script><script src="/data-management-2021-notes/assets/js/2.3c4de620.js" defer></script><script src="/data-management-2021-notes/assets/js/7.58ce105a.js" defer></script>
  </body>
</html>
