<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 4  - Completing the MVC stack</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css" as="style"><link rel="preload" href="/data-management-2021-notes/assets/js/app.a6218cd0.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/2.3c4de620.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/10.b974fcf3.js" as="script"><link rel="prefetch" href="/data-management-2021-notes/assets/js/11.171587da.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/12.25f6e0ab.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/13.f1848b42.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/14.1695e155.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/15.8ff81293.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/16.e625795a.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/3.3730c6e1.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/4.8dbe0c5c.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/5.3fe88dbe.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/6.5aa88d7e.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/7.58ce105a.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/8.87c3beda.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/9.6a381137.js">
    <link rel="stylesheet" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/data-management-2021-notes/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Overview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 1 - Introduction to NodeJS and MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 2 - Exploring Node, Express and Templates</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 3 - MongoDB Queries</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Week 4  - Completing the MVC stack</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/data-management-2021-notes/sessions/week_4/" class="active sidebar-link">Week 4  - Completing the MVC stack</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#the-mcv-stack" class="sidebar-link">The MCV Stack</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#configuring-an-application" class="sidebar-link">Configuring an Application</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#task-1-setting-up-our-sample-application" class="sidebar-link">Task 1 - Setting Up our Sample Application</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#introducing-mongoose" class="sidebar-link">Introducing Mongoose</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#installing-mongoose" class="sidebar-link">Installing Mongoose</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#defining-a-model" class="sidebar-link">Defining a Model</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#task-2-define-a-model-for-the-tasters-collection" class="sidebar-link">Task 2 - Define a model for the tasters collection</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#controllers" class="sidebar-link">Controllers</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#connecting-controllers-to-routes" class="sidebar-link">Connecting controllers to routes</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#presenting-data-with-ejs" class="sidebar-link">Presenting Data with ejs</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#task-3-completing-the-view-layer" class="sidebar-link">Task 3 - Completing the View layer</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_4/#task-4-extended-project-adding-mvc-layers-for-tastings" class="sidebar-link">Task 4 ( extended project) - Adding MVC layers for tastings</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 5 - Getting to Grips With the Assessment</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 6 - Thinking About Updating Data</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 7 - Data Modeling and Relationships</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 8 - User Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 9 - Deploying to a Serverless Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 10 - Further Mongo Relations and Dynamic JavaScript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="week-4-completing-the-mvc-stack"><a href="#week-4-completing-the-mvc-stack" aria-hidden="true" class="header-anchor">#</a> Week 4  - Completing the MVC stack</h1> <div class="tip custom-block"><p>At this stage you should be starting to think about your application that you will be working on for your assessment. Recall, we are just trying to create a simple proof of concept. What is key, you will need to demonstrate that you can pull together the basic elements of a data driven web application to present a simple solution to clearly defined problem.</p></div> <p>I am very excited about this week as we will be tying together everything we have learnt so far. In doing so, we are going to be exploring how we can construct <strong>a model</strong> layer to our application.  Thus completing our MCV stack.</p> <h2 id="the-mcv-stack"><a href="#the-mcv-stack" aria-hidden="true" class="header-anchor">#</a> The MCV Stack</h2> <p><img src="https://joeappleton18.github.io/data-management-2021-notes/images/mvc.png" alt=""></p> <blockquote><blockquote><p>The classic MVC stack</p></blockquote></blockquote> <p>Above is a diagram of the architecture that we are constructing. The Model-View-Controller (MVC) separates and application in two three logical components: the model, view and controller.</p> <h2 id="configuring-an-application"><a href="#configuring-an-application" aria-hidden="true" class="header-anchor">#</a> Configuring an Application</h2> <p>I want to take a quick aside and look at how we can, flexibly, configure our NodeJs applications.</p> <p>According to the Twelve-Factor App, <a href="https://12factor.net/config" target="_blank" rel="noopener noreferrer">&quot;An app’s config is everything that is likely to vary between deploys (staging, production, developer environments, etc).&quot;<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. For instance, in development we will not want to be using our production database. As such, we want to be able to specify, environment specific, applications settings. To achieve this, we can use environment variables.</p> <p>An environment variable is a dynamic name-value pairing that is typically provided by an operating system. What is key, they belong to the environment your application is running on (the operating system), not the application itself.</p> <p>Within a node application, the environment is available to us through the <code>process.env</code> variable. To add custom values to this variable we can use a node module called <code>dotenv</code> coupled with a <code>.env</code> file. The <code>.env</code> file contains our environment variables. It's important to note that the <code>.env</code> file is environment specific and should be added to your <code>.gitignore</code> file so it is not entered into version control. Below is an example of how this configuration works:</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token constant">BASE_URI</span><span class="token operator">=</span>http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost
    <span class="token constant">DB_NAME</span><span class="token operator">=</span>wine
    <span class="token constant">WEB_PORT</span><span class="token operator">=</span><span class="token number">8080</span>
    <span class="token constant">MONGODB_URI</span><span class="token operator">=</span>mongodb<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">27017</span>
</code></pre></div><blockquote><blockquote><p>a <code>.env</code> file, placed in the root directory of our project</p></blockquote></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;dotenv&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><blockquote><p>we can use the .env  settings through the &quot;dotenv&quot; module. Wha</p></blockquote></blockquote> <h2 id="task-1-setting-up-our-sample-application"><a href="#task-1-setting-up-our-sample-application" aria-hidden="true" class="header-anchor">#</a> Task 1 - Setting Up our Sample Application</h2> <p>For the rest of this unit, I will be providing you with a sample application which builds on our wine tasting dataset. I intend to ensure you are all starting with the same code base and will provide you with an up-to-date version the application each week. To get started this week:</p> <ul><li><p><a href="https://github.com/joeappleton18/db-starter-project" target="_blank" rel="noopener noreferrer">Check the README.md instructions on the starter project to get started. This will tell you how to set everything up this week<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p></li> <li><p>You'll notice you will need to seed the database and rename the &quot;.env.example&quot; file to &quot;.env&quot;. Further to this, you will also need to run the database seeder.</p></li> <li><p>You should take a look at the seeder.js file and ensure you have an idea how it works. Using a small side utility to seed a database is common.</p></li></ul> <h2 id="introducing-mongoose"><a href="#introducing-mongoose" aria-hidden="true" class="header-anchor">#</a> Introducing Mongoose</h2> <p>According to <a href="https://developer.mozilla.org/en-US/docs/Learn/Server-side/Express_Nodejs/mongoose" target="_blank" rel="noopener noreferrer">Mozilla<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, there are two approaches to programatically interacting with databases. We can use a query language specific to our given database solution. Alternatively, we can turn to a Object Data Model (&quot;ODM&quot;) or an Object Relational Model (&quot;ORM&quot;). ODM/ORMs abstract away from the underlying database and provide a simplified API. Further to this, they can extend the functionality provided by the native database.</p> <p>In this module, we will be using <a href="https://www.npmjs.com/package/mongoose" target="_blank" rel="noopener noreferrer">Mongoose<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, one of the most popular ODMs used in the NodeJS ecosystem.  On the surface, Mongoose is a light abstraction that sits on top of MongoDB. However, it offers some very useful extensions (<a href="https://mongoosejs.com/docs/guides.html" target="_blank" rel="noopener noreferrer">e.g. Schemas, Models and Validation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>). This week we will be exploring:</p> <ul><li><a href="https://mongoosejs.com/docs/guide.html" target="_blank" rel="noopener noreferrer">Schemas<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://mongoosejs.com/docs/guide.html#models" target="_blank" rel="noopener noreferrer">Models<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h2 id="installing-mongoose"><a href="#installing-mongoose" aria-hidden="true" class="header-anchor">#</a> Installing Mongoose</h2> <p>We can install Mongoose using NPM:</p> <div class="language-shell extra-class"><pre class="language-text"><code>npm install mongoose --save
</code></pre></div><p>Once installed, we need to instruct Mongoose to connect to our database. In <code>app.js</code> we can add the following code:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">WEB_PORT</span><span class="token punctuation">,</span> <span class="token constant">MONGODB_URI</span> <span class="token punctuation">}</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">;</span>

mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token constant">MONGODB_URI</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mongoose<span class="token punctuation">.</span>connection<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
    <span class="token string">&quot;MongoDB connection error. Please make sure MongoDB is running.&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><blockquote><blockquote><p>Telling Mongoose to connect to our MongoDB instance. Notice how we are using an environment variable, the value of which can be located in <code>.env</code>, for our connection string.</p></blockquote></blockquote> <h2 id="defining-a-model"><a href="#defining-a-model" aria-hidden="true" class="header-anchor">#</a> Defining a Model</h2> <p>Recall, in a MVC architecture, a model is the layer that communicates with the database.</p> <p>Models in our application will live in a <code>models</code> folder. As per standard practices we will have a single model per database collection. The model represents the shape of a document in a given collection and also allows us to run operations on the said collection.</p> <p>We should follow a strict naming convention for our models. Each model should live in a models folder and should be the singular name of the collection it represents with the first letter upper case:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">DB</span><span class="token operator">-</span><span class="token constant">STARTER</span><span class="token operator">-</span><span class="token constant">PROJECT</span>
│   <span class="token constant">README</span><span class="token punctuation">.</span>md
│   app<span class="token punctuation">.</span>js   
│
└───models
│   │   Taster<span class="token punctuation">.</span>js
│   │   Tasting<span class="token punctuation">.</span>js

</code></pre></div><blockquote><blockquote><p>This is how our application will look when we create our models. If you check your mongo database you will see that the models relate to two collection, tasters and tastings.</p></blockquote></blockquote> <p>Now we know where our models live, we can consider how we  define them. Let's start with a model called <code>Taster</code> that will shape documents that live in our tasters collection. Below is what each document currently looks like:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
        <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;5f93092985809597ee2b275f&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;twitter&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;@mattkettmann&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;tastings&quot;</span> <span class="token punctuation">:</span> <span class="token number">6332</span><span class="token punctuation">,</span>
        <span class="token string">&quot;name&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;Matt Kettmann&quot;</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><blockquote><p>A single document from our Tasters collection</p></blockquote></blockquote> <p>Recall, MongoDB is schemaless, this means there are no constraints in place to ensure future documents  resemble the our example above. This could be a little risky, if our documents lack consistency we can't run common operations across a given collection. Mongoose allows us to define a schema that will police the data in our document, we then pass this schema into a mongoose model. To understand how this works, let's define our model in <code>models/Taster.js</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token operator">=</span> mongoose<span class="token punctuation">;</span>

<span class="token keyword">const</span> tasterSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    twitter<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
    tastings<span class="token punctuation">:</span> Number<span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> String<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Taster&quot;</span><span class="token punctuation">,</span> tasterSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><blockquote><p>Defining a model, this code should live in <code>models/Taster.js</code></p></blockquote></blockquote> <p>As you can see above, each name/value pairing in our schema definition <a href="https://mongoosejs.com/docs/guide.html" target="_blank" rel="noopener noreferrer">&quot;defines a property in our documents which will be cast to its associated SchemaType&quot;<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. For instance, Twitter will be a string. Notice how we have not defined our <code>_id</code> field. This is because, by default, mongoose adds an _id property for us. Furthermore, notice how we have passed in the following object: <code>{ timestamps: true }</code>  into our Schema method. This option tells mongoose to assign createdAt and updatedAt fields to our schema. Finally, notice how we define a model and export that model in one fell swoop, <code>module.exports = mongoose.model(&quot;Tasters&quot;, tasterSchema);</code>. It is important to know that the model must be named the upper case singular version of its corresponding collection. In this case, our collection is called &quot;tasters&quot; so the model name is, &quot;Taster&quot;.</p> <h2 id="task-2-define-a-model-for-the-tasters-collection"><a href="#task-2-define-a-model-for-the-tasters-collection" aria-hidden="true" class="header-anchor">#</a> Task 2 - Define a model for the tasters collection</h2> <p>Use the notes above, and the <a href="https://mongoosejs.com/docs/guide.html#timestamps" target="_blank" rel="noopener noreferrer">Mongoose<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> documentation, define a model for your tasters collection. You won't actually be using the model yet, this comes next!</p> <h2 id="controllers"><a href="#controllers" aria-hidden="true" class="header-anchor">#</a> Controllers</h2> <p>The controllers in a MVC architecture handle incoming HTTP requests, use models to gather data and hand this data to a view. They are the glue that holds our application to together. In our application, controllers will live in a <code>controllers</code> folder and will represent a specific domain of our application.</p> <p>The naming convention will be singular lower case. As such, our application structure will represent the following:</p> <div class="language- extra-class"><pre class="language-text"><code>DB-STARTER-PROJECT
│   README.md
│   app.js   
│   ....
└───models
│   │   Taster.js
│   │   Tasting.js
└───controllers
│   │   taster.js
│   │   tasting.js
└───views
│   │   index.ejs
|   |   ...
....
</code></pre></div><blockquote><blockquote><p>Our application now resembles an MVC architecture</p></blockquote></blockquote> <p>Let's define two operations in our <code>taster</code> controller (delete, and list). Delete, will delete a taster document and list will list all of our tasters:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Taster <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../models/Taster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">list</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tasters <span class="token operator">=</span> <span class="token keyword">await</span> Taster<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;tasters&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> tasters<span class="token punctuation">:</span> tasters <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">&quot;could not list tasters&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">delete</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> Taster<span class="token punctuation">.</span><span class="token function">findByIdAndRemove</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">&quot;/tasters&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">could not delete  record </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><blockquote><blockquote><p>This code should be placed in <code>controllers/taster.js</code></p></blockquote></blockquote> <p>There are a few points to note above. First, notice how we are not handling specific routes. Rather, we are simply defining and exporting multiple functions that, in <code>app.js</code>, will be attached to given routes. Second, notice how in our list function we are passing data into our view, <code>res.render(&quot;tasters&quot;, { tasters: tasters });</code>. Finally, you should note that we are grabbing an id parameter of the document to delete in our delete function: <code>const id = req.params.id;</code>.</p> <h2 id="connecting-controllers-to-routes"><a href="#connecting-controllers-to-routes" aria-hidden="true" class="header-anchor">#</a> Connecting controllers to routes</h2> <p>As we now have a taster controller set up, we can use the logic  defined in it to process incoming HTTP requests within app.js.</p> <div class="language-js extra-class"><pre class="language-js"><code>    <span class="token keyword">const</span> tasterController <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./controllers/taster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/tasters&quot;</span><span class="token punctuation">,</span> tasterController<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/tasters/delete/:id&quot;</span><span class="token punctuation">,</span> tasterController<span class="token punctuation">.</span>delete<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><blockquote><p>notice how we use . notation to access each function that we have defined in our controller. Moreover, you should also observe that we define ad <code>:id</code>  wild card on our delete route. This gives our controller access to an <code>id</code> parameter. For instance, if we were to visit the route <code>localhost:&lt;port&gt;/tasters/delete/123</code> our id param would equal 123.</p></blockquote></blockquote> <p>You should now be able to visit tasters in your application. However, you'll notice that we are not currently using any of our taster data that we passed in, ejs has our backs here.</p> <h2 id="presenting-data-with-ejs"><a href="#presenting-data-with-ejs" aria-hidden="true" class="header-anchor">#</a> Presenting Data with ejs</h2> <p>Recall, in our taster/list controller function we passed into our render method an object  <code>{ tasters: tasters }</code>. While this object only contains one property, it could contain as several (e.g. <code>{ tasters: tasters, title: &quot;wine taster&quot;, taterCount: 10 }</code> ). Each on of these properties is assigned to a variable and made available to us in our view. For instance, enter the following into your <code>tasters.ejs</code> file:</p> <div class="language-js extra-class"><pre class="language-js"><code>        <span class="token operator">&lt;</span><span class="token operator">%=</span> tasters<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">%</span><span class="token operator">&gt;</span> 
</code></pre></div><p>You should see that you have access to the tasters array, and have displayed the first element. Of course, with arrays we need a little more flexibility. After all,  we don't know the length of the array. EJS allows us to construct and use JavaScript control structures. As such, we can do something like this:</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">%</span> tasters<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">taster</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>        
                    <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span>  taster<span class="token punctuation">.</span>name  <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">&gt;</span>  
  <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
</code></pre></div><p>The above block uses the <code>forEach</code> array operation to iterate across the tasters array. Notice how we mix in control logic (our loop), raw html (ul, li) and output logic (<code>&lt;%= taster.name %&gt;</code>). This takes a little getting used to, and you should read more of the <a href="https://ejs.co/#install" target="_blank" rel="noopener noreferrer">EJS documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h2 id="task-3-completing-the-view-layer"><a href="#task-3-completing-the-view-layer" aria-hidden="true" class="header-anchor">#</a> Task 3 - Completing the View layer</h2> <ul><li><p>Can you complete the view layer so the wine tasters are displayed int the table.</p></li> <li><p>You should also be able to add the delete functionality, so you can delete wine tasters (remember you can just use the seeder to reset everything). A tip, we can delete a given taster by visiting the delete url with the id parameter of the taster we want to delete. Your code will look something like this: <code>href=&quot;/tasters/detele/&lt;%= taster._id %&gt;&quot;</code></p></li></ul> <h2 id="task-4-extended-project-adding-mvc-layers-for-tastings"><a href="#task-4-extended-project-adding-mvc-layers-for-tastings" aria-hidden="true" class="header-anchor">#</a> Task 4 ( extended project) - Adding MVC layers for tastings</h2> <ul><li><p>Now you know the basics, can you construct MVC layers for our tastings collections. You can use the table we are using for tasters. To begin with limit your results to ~50 tastings.</p></li> <li><p>Consider how you can paginate the results as we have many thousands of tastings. Pagination is quite advanced, but an interesting challenge. <a href="https://softwareontheroad.com/pagination-in-nodejs-mongo/" target="_blank" rel="noopener noreferrer">This article is good<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. <a href="https://getbootstrap.com/docs/4.0/components/pagination/" target="_blank" rel="noopener noreferrer">Further to this, boostrap has some built in pagination controls we can use<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/data-management-2021-notes/sessions/week_3/" class="prev">Week 3 (MongoDB Queries)</a></span> <span class="next"><a href="/data-management-2021-notes/sessions/week_5/">Week 5 (Getting to Grips With the Assessment)</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/data-management-2021-notes/assets/js/app.a6218cd0.js" defer></script><script src="/data-management-2021-notes/assets/js/2.3c4de620.js" defer></script><script src="/data-management-2021-notes/assets/js/10.b974fcf3.js" defer></script>
  </body>
</html>
