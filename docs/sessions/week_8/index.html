<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 8 ( User Authentication)</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css" as="style"><link rel="preload" href="/data-management-2021-notes/assets/js/app.e6f3d824.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/2.3c4de620.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/14.3ebe8739.js" as="script"><link rel="prefetch" href="/data-management-2021-notes/assets/js/10.2967f4ae.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/11.169bdd06.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/12.179d4db9.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/13.0c70be33.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/15.14310365.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/16.e625795a.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/3.3730c6e1.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/4.8dbe0c5c.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/5.0584c251.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/6.0103f2f9.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/7.328a8e25.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/8.87c3beda.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/9.7400f78e.js">
    <link rel="stylesheet" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/data-management-2021-notes/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Overview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 1 - Introduction to NodeJS and MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 2 - Exploring Node, Express and Templates</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 3 - MongoDB Queries</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 4  - Completing the MVC stack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 5 - Getting to Grips With the Assessment</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 6 - Thinking About Updating Data</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 7 - Data Modeling and Relationships</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Week 8 - User Authentication</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/data-management-2021-notes/sessions/week_8/" class="active sidebar-link">Week 8 ( User Authentication)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_8/#storing-passwords-in-a-database" class="sidebar-link">Storing Passwords in a Database</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_8/#theoretical-task" class="sidebar-link">Theoretical Task</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_8/#representing-the-user-in-a-database" class="sidebar-link">Representing the User In a Database</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_8/#task-1-set-up" class="sidebar-link">Task 1 - Set up</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_8/#constructing-our-login-form" class="sidebar-link">Constructing Our Login Form</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_8/#task-2-construct-a-login-form" class="sidebar-link">Task 2 - Construct A Login Form</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_8/#creating-user-sessions" class="sidebar-link">Creating User Sessions</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_8/#protecting-routes" class="sidebar-link">Protecting Routes</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_8/#task-3" class="sidebar-link">Task 3</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 9 - Deploying to a Serverless Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 10 - Further Mongo Relations and Dynamic JavaScript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="week-8-user-authentication"><a href="#week-8-user-authentication" aria-hidden="true" class="header-anchor">#</a> Week 8 ( User Authentication)</h1> <div class="tip custom-block"><p><strong>session dependencies</strong>
This week we are continuing with our wine tasting theme. Please ensure you have the latest version
of the project</p> <p>You can clone this version using the following command:</p> <p><code>git clone https://github.com/joeappleton18/db-starter-project.git --single-branch --branch week-7-solutions</code></p></div> <p>So far, we have been creating new tastings/tasters without attributing them to a user. In reality, a user should probably login before they can post to our database. This week we are going to address this point by answering the following question and sub questions:</p> <h4 id="how-can-i-allow-users-to-register-and-securely-login-to-my-wines-database"><a href="#how-can-i-allow-users-to-register-and-securely-login-to-my-wines-database" aria-hidden="true" class="header-anchor">#</a> How can I allow users to register and securely login to my wines database?</h4> <ul><li>How can I manage users so they remain logged in between sessions?</li> <li>How can I allow users to enter a password, while keeping this password hidden from my application?</li></ul> <p>In addressing the above questions, we are going to consider simple user authentication. We will not cover ideas such as multiple user roles (e.g. super-admin, admin, users).  <strong>You should note,</strong> I don't expect you to use multiple role for your assessment. However, you may well acknowledge that in the future multiple roles will be required. Moreover, I do not expect you to use a sophisticated and highly secure authentication process.</p> <h2 id="storing-passwords-in-a-database"><a href="#storing-passwords-in-a-database" aria-hidden="true" class="header-anchor">#</a> Storing Passwords in a Database</h2> <center><img src="https://joeappleton18.github.io/data-management-2021-notes/images/password-hashing.png" width="{300}"></center> <blockquote><blockquote><p>The correct, but still somewhat risky, way to store a password</p></blockquote></blockquote> <p>We should <strong>never</strong> store plain text passwords in a database. If this were the case, should a data breach occur, our user's passwords will be freely accessible to the public!</p> <p>Most users unfortunately use same password across multiple sites and applications. If our site were to reveal an email and password pairing, an attacker could attempt to use this information to login to wider sites 😬. It is vital to avoid this house of cards scenario.</p> <p>The solution to the above catastrophe is to hash our password. You can think of a hash function as a black box that takes in plain text and outputs a fixed sized unique string. It is this hashed string that we store in the database, <strong>not</strong> the plain text password. Crucially, when we re-run the hash function, with the same password, the same unique string is generated every time. This means to determine if a user password correct, we compare the hash password with the password stored in our database.</p> <p>It is important to note that not all hash functions are created equal. With some (e.g., MD5), only being marginally better than storing plain text passwords. The problem with hashing functions like MD5 is they have been widely, and naively used, for many years. As such, large tables (rainbow tables or dictionaries) are available that associate MD5 hashes to their plain text equivalent. <a href="https://crackstation.net/" target="_blank" rel="noopener noreferrer">As, an experiment, see if you can crack the following hash 8ff32489f92f33416694be8fdc2d4c22<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. We can avoid this type of attack by salting our passwords. This involves adding a string to our password before hashing, we could also perform multiple iterations of our function. However, since MD5 is so fast, our passwords are still susceptible to brute force attacks. In avoiding the vulnerabilities of MD5, we are going to using  <strong>bcrypt</strong> to hash our passwords.</p> <p>bcrypt has the following security features:</p> <ul><li>incorporates, by default, a salt to protect against rainbow table</li> <li>it's slow - this is good - as it is resistent to brute force attacks</li> <li>it's adaptive, allowing the developer to increase or decrease the speed of the function</li></ul> <h2 id="theoretical-task"><a href="#theoretical-task" aria-hidden="true" class="header-anchor">#</a> Theoretical Task</h2> <p>Let's play around with some different hashing algorithms and consider the computational expense of each. First, let's install the node libraries form two algorithms (bcrypt and md5):</p> <div class="language-shell extra-class"><pre class="language-text"><code>npm install md5 bcrypt
</code></pre></div><blockquote><blockquote><p>terminal - installing bcrypt and md5 hashing libraries</p></blockquote></blockquote> <p>Next, let's crete a file called <code>testbed.js</code> and we can construct a crude test:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token keyword">const</span> md5 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'md5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcrypt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> <span class="token function-variable function">testBed</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">const</span> testString <span class="token operator">=</span> <span class="token string">&quot;advanced databases&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">/* Begin our test */</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//const hash = md5(testString);</span>
    <span class="token comment">//const hash = await bcrypt.hashSync(testString, 10);</span>
    <span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;the total time taken is: &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'seconds'</span><span class="token punctuation">)</span>

    <span class="token comment">/* End our test */</span>

<span class="token punctuation">}</span>

<span class="token function">testBed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


</code></pre></div><blockquote><blockquote><p>testbed.js - to run we can just use `node testbed.js</p></blockquote></blockquote> <h3 id="references"><a href="#references" aria-hidden="true" class="header-anchor">#</a> References</h3> <p>Ntantogian, C., Malliaros, S. and Xenakis, C. (2019). Evaluation of password hashing schemes in open source web platforms. Computers &amp; Security, 84, pp.206–224.</p> <h2 id="representing-the-user-in-a-database"><a href="#representing-the-user-in-a-database" aria-hidden="true" class="header-anchor">#</a> Representing the User In a Database</h2> <p>We need to create a user collection to store our users. Let's keep things very simple and represent our users using the following document structure:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
        <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;5fafe79af96f1554d34320ca&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;email&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;joeappleton18@hotmail.com&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;password&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;$2b$10$ffPZCGmD1SSfKfqlFvbuP.zzA.2UOInT&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;createdAt&quot;</span> <span class="token punctuation">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">&quot;2020-11-14T14:20:10.927Z&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">&quot;updatedAt&quot;</span> <span class="token punctuation">:</span> <span class="token function">ISODate</span><span class="token punctuation">(</span><span class="token string">&quot;2020-11-14T14:20:10.927Z&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>users collection - user document</li></ul> <p>So far, we have a very normal looking document in terms of the values that are stored. However, we need a way to hash the password before it is stored in the database. Recall, we are going to use <code>&quot;bcrypt</code> to achieve this. As such, let's install the nodeJS bcrypt library: <code>npm install bcrypt</code>. We can take advantage of the Schema <code>pre</code> hook, <a href="https://mongoosejs.com/docs/api.html#schema_Schema-pre" target="_blank" rel="noopener noreferrer">provided by Mongoose<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to hash the user's password before it hits the database. To explore how this works let's create a <code>user</code> model:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;mongoose&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token operator">=</span> mongoose<span class="token punctuation">;</span>
<span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcrypt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> userSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
        email<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'email is required'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> unique<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        password<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'password is required'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

userSchema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// logging </span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> hash<span class="token punctuation">;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'could not hash password'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span> userSchema<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><blockquote><p>models/User.js - our user model utilising a pre hook to hash the password</p></blockquote></blockquote> <p>The interesting part to the above code is our <code>userSchema.pre</code> hook. Hooks allow us to, as they sound, hook onto specific actions. Mongoose makes pre and post hooks available to us to facilitate middleware:</p> <blockquote><blockquote><p><a href="https://mongoosejs.com/docs/middleware.html" target="_blank" rel="noopener noreferrer">Middleware (also called pre and post hooks) are functions which are passed control during execution of asynchronous functions. Middleware is specified on the schema level and is useful for writing plugins.<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote></blockquote> <p>In the code above, we are hooking onto a Mongoose <code>save</code> event - represented by the first string parameter we pass into the hook function. The second parameter is, the middleware, function that will be run. You must use the long form <code>function (next)</code> here, not <code>(next) =&gt;</code>.  This is a nuance of javaScript, allowing us to keep the <code>this</code> keyword bound to to the function itself (sorry this is a bit confusing, but it's hard to capture this idea in a sentence). Notice how we can now access the values that are to be inserted into the database by using <code>this.&lt;property name&gt;</code> format (e.g. <code>this.email, this.password</code>).</p> <p>Next, we execute the following lines of code to hash our password:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>    <span class="token keyword">const</span> hash <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> hash<span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Above, we generate a password hash by calling <code>bcrypt.hash(this.password, 10);</code>. Notice, how it's asynchronous, this is because it is slow - which is good. The speed is dictated by rounds of hashing that is run. In this case we are requesting for 10 rounds - represented by the second parameter. As we've seen earlier, on the one hand, increasing this number makes our hashes less susceptible to brute-force search attacks. On the other, the time it takes to generate the hash increases exponentially. Finally, notice how we override the password with its hash value  <code>this.password = hash;</code> and then call  <code>next();</code>. Next, is passed into our middleware by Mongoose. We must call it, otherwise our application will hang. The result of our middleware, is that the user's password will be stored in a hashed format.</p> <h2 id="task-1-set-up"><a href="#task-1-set-up" aria-hidden="true" class="header-anchor">#</a> Task 1 - Set up</h2> <p>Use everything you have learnt so far to:</p> <ul><li>Set up a <code>/join</code> route, that renders <code>views/create-user.ejs</code></li> <li>Construct a <code>models/User.js</code> (see above), that stores users in a <code>users</code> collection and hashes their passwords using bcrypt.</li> <li>Create a <code>controllers/user.js</code> controller and implement a <code>create</code> function that creates a new user</li> <li>See if you can now create a new user, redirecting the user to <code>/</code> on a successful registration.</li></ul> <h2 id="constructing-our-login-form"><a href="#constructing-our-login-form" aria-hidden="true" class="header-anchor">#</a> Constructing Our Login Form</h2> <p>Currently, our user can join our wine tasting platform and we are able to store their password in a hashed format. To allow the user to login we need to construct a login form (this is easy, it's the same as our join form), and construct the functionality to allow their plain text password to be hashed and compared with the hash stored with their email in the database. This is actually fairly straight forward:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login-user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> errors<span class="token punctuation">:</span> <span class="token punctuation">{</span> email<span class="token punctuation">:</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'email not found'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'authenticated'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'login-user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> errors<span class="token punctuation">:</span> <span class="token punctuation">{</span> password<span class="token punctuation">:</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'password does not match'</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>


    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            message<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><blockquote><p>controllers/user.js - using bcrypt to validate a user</p></blockquote></blockquote> <p>Above, we first use our user's email to locate them in the database. We can do this since we have configured  email as <code>unique: true</code> incorporates the user schema. Next, we compare the users plain text password with the hash, using <code>await bcrypt.compare()</code>. The <code>compare()</code> function returns <code>true</code> or <code>false</code>, depending on whether the plane text password when hashed matches the hash stored in the database.</p> <h2 id="task-2-construct-a-login-form"><a href="#task-2-construct-a-login-form" aria-hidden="true" class="header-anchor">#</a> Task 2 - Construct A Login Form</h2> <p>Use the notes above to create a login form. As per above, on successful login, <code>console.log('authenticated')</code> so you know your functionality works.</p> <h2 id="creating-user-sessions"><a href="#creating-user-sessions" aria-hidden="true" class="header-anchor">#</a> Creating User Sessions</h2> <p>As it stands, a user can sign-up and log-in to our wine tasting application. However, currently, we have no way of persisting the fact that a user has actually logged in. Since HTTP is stateless, this means we can't use the protocol to keep track of users between page requests. As such, to achieve this, we need to use what's know as a user session.</p> <p>User sessions are implemented using HTTP cookie. You'll be aware that web applications use cookies to store information. Cookies are stored by web browsers and sent to the originating server with each request to this server. We can use this functionality to store a user id in a cookie that will allow us to authenticate the user between requests. Let's consider how this can be done.</p> <p>We can utilise a npm package called <code>express-session</code> to maintain our user sessions. To install it, run <code>npm install express-session</code>. Next, within app.js we can require and initialise our session:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> expressSession <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;express-session&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">expressSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span> secret<span class="token punctuation">:</span> <span class="token string">'foo barr'</span><span class="token punctuation">,</span> cookie<span class="token punctuation">:</span> <span class="token punctuation">{</span> expires<span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token number">253402300000000</span><span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre></div><blockquote><blockquote><p>app.js setting up a session, the secret is an identifier for our application. I've set the cookie expiry data to a distant point in the future</p></blockquote></blockquote> <p>Now we've initiated our cookie, we need to set its value when the user logs in. Let's update our <code>controllers/user.js</code> <code>login</code>  method so that it stores the logging in user id to the cookie. Currently, we are just logging to the console, 'authenticated'  if the user authenticates, it is this section of code that we need to update:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">login</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
         
        <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> email<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">...</span> 
        
        <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>password<span class="token punctuation">,</span> user<span class="token punctuation">.</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
       <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userID <span class="token operator">=</span> user<span class="token punctuation">.</span>_id<span class="token punctuation">;</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userID<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token operator">...</span>

<span class="token punctuation">}</span>

</code></pre></div><blockquote><blockquote><p>controllers/user.js - Assigning the user session to the user_id. This will allow us to identify the user for future requests</p></blockquote></blockquote> <h4 id="storing-our-logged-in-user-details"><a href="#storing-our-logged-in-user-details" aria-hidden="true" class="header-anchor">#</a> Storing our Logged in User Details</h4> <p>Above, we've explored how to set up session containing the logged in user id. We now need to this information to manage our logged in user within our application. To do this, we are going to define two express middlewear functions in app.js.</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>global<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userID <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>global<span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    global<span class="token punctuation">.</span>user <span class="token operator">=</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div><blockquote><blockquote><p>app.js - a custom express middleware function</p></blockquote></blockquote> <p>Above, the our custom middleware will fire on every request, hence the wild card symbol <code>&quot;*&quot;</code>. Notice, how the session is injected into our request for us, and we can access it like this: <code>req.session.userID</code>. Next we use a little trick, we set what's know as a global variable <code>global.user = false;</code>. Notice how we assign our logged in user to this variable, <code>global.user = user;</code>. Since user is now global we can access it everywhere, including in our <code>EJS</code> templates! If all has worked correctly, placing <code>&lt;%= user %&gt;</code> in one of your templates should output the current user. Given that we now have this global, <code>user</code>, variable available to us in our views, we can conditionally show content based on the user being logged-in. Try amending <code>views/common/header.ejs</code> to conditionally show some links, as follows:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>    <span class="token operator">...</span>
    <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
        <span class="token operator">...</span>
        <span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-link&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;logout&quot;</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">%=</span> user<span class="token punctuation">.</span>email <span class="token operator">%</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>Logout<span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span> <span class="token operator">&lt;</span><span class="token operator">%</span>
    <span class="token punctuation">}</span><span class="token operator">%</span><span class="token operator">&gt;</span> 
    <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-link&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;login&quot;</span><span class="token operator">&gt;</span> Login <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>a <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;nav-link&quot;</span> href<span class="token operator">=</span><span class="token string">&quot;join&quot;</span><span class="token operator">&gt;</span> Register <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
    <span class="token operator">...</span> 

</code></pre></div><blockquote><blockquote><p>views/common/header.ejs - conditionally rendering our menu based on the user being logged in</p></blockquote></blockquote> <h2 id="protecting-routes"><a href="#protecting-routes" aria-hidden="true" class="header-anchor">#</a> Protecting Routes</h2> <p>We're very nearly there with our authentication journey. You may have noticed that, as it stands, we have not locked down any routes. For instance, I could still visit <code>create-taster</code> whether I am logged in or not. Let's write one final pice of middleware to help us lock down routes:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code> <span class="token keyword">const</span> <span class="token function-variable function">authMiddleware</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span><span class="token punctuation">.</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/create-taster&quot;</span><span class="token punctuation">,</span> authMiddleware<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;create-taster&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><blockquote><blockquote><p>app.js - the middleware above redirects un-authenticated users back to the <code>/</code> home page. Notice how we are selective where we use it, locking down our create-taster route - in this instance</p></blockquote></blockquote> <p>Finally, let's consider how a user can log our. All we need to do is set up a route, that when visited destroys our session and sets the global <code>user</code> variable to <code>false</code></p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/logout&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  req<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  global<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><blockquote><p>app.js - a logout route. We now just need to set up a link in our header pointing to <code>/logout</code> and the user will be able to logout (I'll let you work out how to do this)</p></blockquote></blockquote> <h2 id="task-3"><a href="#task-3" aria-hidden="true" class="header-anchor">#</a> Task 3</h2> <p>Use the notes above to finish off our authentication system. On successful completion:</p> <ul><li>The header links should adapt based on a users being logged in</li> <li>Your 'create' routes should all be locked down, unless a user is logged in</li> <li>A user should be able to logout</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/data-management-2021-notes/sessions/week_7/" class="prev">Week 7 (Data Modeling and Relationships)</a></span> <span class="next"><a href="/data-management-2021-notes/sessions/week_9/">Week 9 (Deploying to a Serverless Infrastructure)</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/data-management-2021-notes/assets/js/app.e6f3d824.js" defer></script><script src="/data-management-2021-notes/assets/js/2.3c4de620.js" defer></script><script src="/data-management-2021-notes/assets/js/14.3ebe8739.js" defer></script>
  </body>
</html>
