<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 7 (Data Modeling and Relationships)</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css" as="style"><link rel="preload" href="/data-management-2021-notes/assets/js/app.59276b66.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/2.3c4de620.js" as="script"><link rel="preload" href="/data-management-2021-notes/assets/js/13.0b1d5c6c.js" as="script"><link rel="prefetch" href="/data-management-2021-notes/assets/js/10.6f0a3588.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/11.171587da.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/12.2d86f222.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/14.92eb9f83.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/15.14310365.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/16.e625795a.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/3.3730c6e1.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/4.8dbe0c5c.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/5.3fe88dbe.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/6.5aa88d7e.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/7.263dbb29.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/8.912dd950.js"><link rel="prefetch" href="/data-management-2021-notes/assets/js/9.7619922d.js">
    <link rel="stylesheet" href="/data-management-2021-notes/assets/css/0.styles.b262af1c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/data-management-2021-notes/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Overview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 1 - Introduction to NodeJS and MongoDB</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 2 - Exploring Node, Express and Templates</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 3 - MongoDB Queries</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 4  - Completing the MVC stack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 5 - Getting to Grips With the Assessment</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 6 - Thinking About Updating Data</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Week 7 - Data Modeling and Relationships</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/data-management-2021-notes/sessions/week_7/" class="active sidebar-link">Week 7 (Data Modeling and Relationships)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#relationships-in-nosql-theory-focus" class="sidebar-link">Relationships In NoSQL (Theory Focus)</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#one-to-few" class="sidebar-link">One-to-Few</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#one-to-many" class="sidebar-link">One-to-Many</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#one-to-squillions" class="sidebar-link">One-to-Squillions</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#practical" class="sidebar-link">Practical</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#task-1-constructing-further-collections" class="sidebar-link">Task 1 - Constructing further collections</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#defining-relationships" class="sidebar-link">Defining relationships</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#task-2-defining-relations" class="sidebar-link">Task 2 - Defining Relations</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#inserting-related-data" class="sidebar-link">Inserting Related Data</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#task-3-create-a-tasting" class="sidebar-link">Task 3 - Create a Tasting</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#one-to-many-user-input" class="sidebar-link">One-to-Many User Input</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#task-4-add-regions-to-create-tasting" class="sidebar-link">Task 4 - Add Regions to Create Tasting</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#task-5-update-tasting" class="sidebar-link">Task 5 - Update Tasting</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#mongoose-aggregation" class="sidebar-link">Mongoose Aggregation</a></li><li class="sidebar-sub-header"><a href="/data-management-2021-notes/sessions/week_7/#task-6-aggregation-play" class="sidebar-link">Task 6 - Aggregation Play</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 8 - User Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 9 - Deploying to a Serverless Infrastructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 10 - Further Mongo Relations and Dynamic JavaScript</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="week-7-data-modeling-and-relationships"><a href="#week-7-data-modeling-and-relationships" aria-hidden="true" class="header-anchor">#</a> Week 7 (Data Modeling and Relationships)</h1> <div class="tip custom-block"><p><strong>Session dependencies</strong></p> <p>This week we are continuing with our wine tasting theme. Please ensure you have the latest version of the project</p> <p>You can clone this version using the following command:</p> <p><code>git clone https://github.com/joeappleton18/db-starter-project.git --single-branch --branch week-6-solutions</code></p></div> <p>This week promises to address, that perhaps nagging,  question:</p> <p>** How can we construct relationships when working with non-relational databases?**</p> <p>You'll learn, that non-relational does not mean no-relations, that would be very sad üòø. We'll also take the opportunity to look at some more advanced MongoDB queries. In doing so, we'll be able to dynamically populate the statistics on our wine tasting home page.</p> <h2 id="relationships-in-nosql-theory-focus"><a href="#relationships-in-nosql-theory-focus" aria-hidden="true" class="header-anchor">#</a> Relationships In NoSQL (Theory Focus)</h2> <p>This week I want to focus the reading and discussion on a series of <a href="https://www.mongodb.com/blog/post/6-rules-of-thumb-for-mongodb-schema-design-part-1" target="_blank" rel="noopener noreferrer">blog articles  by<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>  William Zola, MongoDB's technical support engineer.</p> <p>The articles address the common question of, &quot;How do I model a One-to-N relationship?‚Äù&quot;</p> <p>William states that there are many different ways to construct One-to-N relationships in NoSql databases. He goes on to suggest that, in the non-relational world we must think a little differently about the nature of the relationship:</p> <blockquote><blockquote><p>When designing a MongoDB schema, you need to start with a question that you‚Äôd never consider when using SQL: what is the cardinality of the relationship? Put less formally: you need to characterize your ‚ÄúOne-to-N‚Äù relationship with a bit more nuance: is it ‚Äúone-to-few‚Äù, ‚Äúone-to-many‚Äù, or ‚Äúone-to-squillions‚Äù? Depending on which one it is, you‚Äôd use a different format to model the relationship.</p></blockquote></blockquote> <p>Let's briefly consider each of these relationships, where possible, in the context of our wine tasting application</p> <h2 id="one-to-few"><a href="#one-to-few" aria-hidden="true" class="header-anchor">#</a> One-to-Few</h2> <p>If we have a small number of relations we can just embed these relations directly in the parent document. For instance, a user may have many addresses.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">'Joe Appleton'</span><span class="token punctuation">,</span>
  addresses <span class="token punctuation">:</span> <span class="token punctuation">[</span>
     <span class="token punctuation">{</span> street<span class="token punctuation">:</span> <span class="token string">'123 Sesame St'</span><span class="token punctuation">,</span> city<span class="token punctuation">:</span> <span class="token string">'Anytown'</span><span class="token punctuation">,</span> cc<span class="token punctuation">:</span> <span class="token string">'USA'</span><span class="token punctuation">,</span> primary<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{</span> street<span class="token punctuation">:</span> <span class="token string">'123 Avenue Q'</span><span class="token punctuation">,</span> city<span class="token punctuation">:</span> <span class="token string">'New York'</span><span class="token punctuation">,</span> cc<span class="token punctuation">:</span> <span class="token string">'USA'</span><span class="token punctuation">,</span> primary<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p>We don't currently have a user table; so I've adapted the example given in the article.</p></blockquote></blockquote> <p>The data modeling design above is simple, and does not require an extra collection. However, it's more complex to query these embedded fields across different documents. For example, queries asking things like, how many users live in the US? - become a little trickier. I tend to use this approach if the embedded data is only going to be used by its parent. In other words, we are not going to need to compare query this data across multiple documents.</p> <h2 id="one-to-many"><a href="#one-to-many" aria-hidden="true" class="header-anchor">#</a> One-to-Many</h2> <p>One wine tasting can have Many Regions. We can achieve this relationship by constructing an array of region object ids.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  _id<span class="token punctuation">:</span> <span class="token function">ObjectID</span><span class="token punctuation">(</span><span class="token string">'wine123'</span><span class="token punctuation">)</span>
  title<span class="token punctuation">:</span> <span class="token string">'toro loco'</span>
  regions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token function">ObjectID</span><span class="token punctuation">(</span><span class="token string">'1234'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">ObjectID</span><span class="token punctuation">(</span><span class="token string">'1234'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p>tasting document</p></blockquote></blockquote> <p>The above approach, which we will implement today, involves creating a separate regions collection. According to the blog post, we could then retrieve all regions for any given wine tasting record by constructing a &quot;application level&quot; join.</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>tasting <span class="token operator">=</span> db<span class="token punctuation">.</span>tastings<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token string">&quot;wine123&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// now we have the tasting we can use $in to get all the regions. It's</span>
<span class="token comment">// similar to a SQL or</span>
tasting  <span class="token operator">=</span> db<span class="token punctuation">.</span>regions<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>_id<span class="token punctuation">:</span> <span class="token punctuation">{</span> $<span class="token keyword">in</span> <span class="token punctuation">:</span> tasting<span class="token punctuation">.</span>regions <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
</code></pre></div><blockquote><blockquote><p>Constructing a one to many join</p></blockquote></blockquote> <p>The above requires an extra read operation, so it's slightly slower than our One-to-Few relationship. However, since <code>_id</code>s are indexed there is very little difference.</p> <h2 id="one-to-squillions"><a href="#one-to-squillions" aria-hidden="true" class="header-anchor">#</a> One-to-Squillions</h2> <p>This approach is only required if you think that your relationship will cause your documents to exceed the 16MB document limit. For instance, consider you wanted to keep a permanent user log - this could grow very large. As such, we could not maintain an array of log messages.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token operator">...</span>
  _id<span class="token punctuation">:</span> <span class="token function">ObjectID</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span>
  user_id<span class="token punctuation">:</span> <span class="token function">ObjectID</span><span class="token punctuation">(</span><span class="token string">'456'</span><span class="token punctuation">)</span>
  type<span class="token punctuation">:</span> <span class="token string">'info'</span>
  message<span class="token punctuation">:</span> <span class="token string">'user visited the module survey form and gave Joe 5 out of 5 üòÅ '</span><span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p>A user logger</p></blockquote></blockquote> <p>Above, we associate each log message to a specific user. We could easily obtain the user for each log message by using <code>populate</code> provided for us by mongoose:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> logRef <span class="token operator">=</span> Log<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> log <span class="token operator">=</span> logRef<span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'user_id'</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><blockquote><p>An example of using mongoose to populate the user associated to our log</p></blockquote></blockquote> <h3 id="references"><a href="#references" aria-hidden="true" class="header-anchor">#</a> References</h3> <p>Zola, W. (2014). 6 Rules of Thumb for MongoDB Schema Design: Part 1 | MongoDB Blog. [online] MongoDB. Available at: https://www.mongodb.com/blog/post/6-rules-of-thumb-for-mongodb-schema-design-part-1 [Accessed 14 Nov. 2020].</p> <h2 id="practical"><a href="#practical" aria-hidden="true" class="header-anchor">#</a> Practical</h2> <p>This week we are going to explore how to construct and manage relationships by implementing the functionality to update and create wine tastings.</p> <p>When creating/updating a wine tasting a few challenges arise. Let's consider some of the properties on the wine tasting document that stand out:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token operator">...</span>
 <span class="token string">&quot;designation&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;Mascaria Barricato&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;variety&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;Red Blend&quot;</span>
 <span class="token string">&quot;province&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;Sicily &amp; Sardinia&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;country&quot;</span> <span class="token punctuation">:</span> <span class="token string">&quot;Italy&quot;</span><span class="token punctuation">,</span>
 <span class="token string">&quot;regions&quot;</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Cerasuolo di Vittoria&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p>Variety, province, country and regions need to be consistent</p></blockquote></blockquote> <p>Variety, province, country and regions are all fields that we would like users to select with a drop down menu. It would not make sense for a user to type in these values. As such, we  need to maintain some collections that allow us to easily reference and update our common repeating fields on our tasters collection. In other words, we need to extend our seeder file, constructing a Varieties, Countries, Provinces , and Regions collection.</p> <p>We have two options available to us here:</p> <ul><li><p>We could find further external data sources; for instance, a JSON list of countries would be easy to find.</p></li> <li><p>We could ask our existing data to provide us with this information.</p></li></ul> <p>We are going with the latter option. This presents a future challenge, as we will need to add some functionality that allows users to create, for instance, new regions. However, on the flip-side, we can very quickly generate our initial collections. Moreover, given that we are generating this seed data from 130k records, I am hazarding to guess we will get a fairly complete list (wild speculation). <a href="https://docs.mongodb.com/manual/aggregation/" target="_blank" rel="noopener noreferrer">We can use the MongoDB aggregation pipeline to help us here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h3 id="a-quick-introduction-to-the-aggregation-pipeline"><a href="#a-quick-introduction-to-the-aggregation-pipeline" aria-hidden="true" class="header-anchor">#</a> A Quick Introduction to the Aggregation Pipeline</h3> <p>According to the MongoDB team, <a href="https://docs.mongodb.com/manual/aggregation/" target="_blank" rel="noopener noreferrer">&quot;MongoDB‚Äôs aggregation framework is modeled on the concept of data processing pipelines. Documents enter a multi-stage pipeline that transforms the documents into an aggregated result&quot;<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Simple right! To understand this idea, let's consider how we might generate a list of provinces and output that list to a new collection called &quot;provinces&quot; - we can do all of this using aggregation:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>tastings<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>$group<span class="token punctuation">:</span> <span class="token punctuation">{</span>_id<span class="token punctuation">:</span> <span class="token string">&quot;$province&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>$project<span class="token punctuation">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&quot;$_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><blockquote><p>An aggregation command to group our tastings collection by provinces</p></blockquote></blockquote> <p>If you run the above command, in a VS code MongoPlayground or through the command line, you will see a list of unique provinces; but, how did we get to this output?</p> <ul><li><p>First, we told MongoDB that we wanted to run an aggregation on our tasting collection <code>db.tastings.tastings.aggregate([])</code>. Notice how we pass an array in, this represents our pipeline. We can pass as many aggregation operations as we like into this pipeline. Each operation will be passed the data generated from its immediate predecessor.</p></li> <li><p>Next, we run our first aggregation operation - <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/group/#pipe._S_group" target="_blank" rel="noopener noreferrer">group<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This operation, distinctly groups all of our documents by a given _id. In this case the <code>_id</code> is <code>$province</code>. Notice how we use the <code>$</code> sign to indicate that we want to use a document property.</p></li> <li><p>Finally, <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/" target="_blank" rel="noopener noreferrer">we use the project aggregation operator<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This allows us to further shape the output. In our case we set up a province property <code>name: &quot;$_id&quot;</code>, and remove the <code>$_id</code> field <code>&quot;_id&quot; : 0</code>. This has the effect of renaming <code>&quot;_id&quot;</code> to <code>&quot;name&quot;</code>. Again, notice how we use <code>$</code> to reference aggregated data.</p></li></ul> <p>MongoDB provides us a further aggregation operation called out. This allows us to output to a new collection the results of our aggregation:</p> <div class="language-js extra-class"><pre class="language-js"><code>db<span class="token punctuation">.</span>tastings<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>$group<span class="token punctuation">:</span> <span class="token punctuation">{</span>_id<span class="token punctuation">:</span> <span class="token string">&quot;$province&quot;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>$project<span class="token punctuation">:</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&quot;$_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>$out<span class="token punctuation">:</span> <span class="token string">&quot;provinces&quot;</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><blockquote><blockquote><p>Above, we output our aggregated results to a new collection called provinces.</p></blockquote></blockquote> <h2 id="task-1-constructing-further-collections"><a href="#task-1-constructing-further-collections" aria-hidden="true" class="header-anchor">#</a> Task 1 - Constructing further collections</h2> <ul><li><p>Within MongoDB's terminal runtime, or in a VS code playground. Use the aggregation techniques explored above to create a: varieties, countries, provinces , and regions collection. <strong>Hint, make sure you are happy with the output before you use the $out step</strong>. Use a name property to hold the value (e.g. county).</p></li> <li><p>When you are happy with the output, see if you can update <code>seeder.js</code> to include these aggregation steps. There is a slight difference in syntax in the <code>seeder.js</code> as we are using the node MongoDB package:</p></li></ul> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&quot;tastings&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token punctuation">{</span> $unwind<span class="token punctuation">:</span> <span class="token string">&quot;$regions&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> $group<span class="token punctuation">:</span> <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token string">&quot;$regions&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> $project<span class="token punctuation">:</span> <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;$_id&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;_id&quot;</span><span class="token punctuation">:</span> <span class="token number">0</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> $out<span class="token punctuation">:</span> <span class="token string">&quot;regions&quot;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
</code></pre></div><blockquote><blockquote><p>An example of how to run set up a aggregation pipeline using the node driver. Notice how I've chained <code>toArray()</code> to the <code>aggregate</code> function. This is needed otherwise the aggregation does not resolve. <a href="https://stackoverflow.com/questions/49835278/mongodb-node-js-out-with-aggregation-only-working-if-calling-toarray" target="_blank" rel="noopener noreferrer">A painful few hours were spent finding this out<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote></blockquote> <ul><li>Create models for each of the collections we created above. You may want to add some validation. Remember, we use the singular name of each collection to define our model:</li></ul> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> Schema <span class="token punctuation">}</span> <span class="token operator">=</span> mongoose<span class="token punctuation">;</span>

<span class="token keyword">const</span> countrySchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span> <span class="token punctuation">{</span> type<span class="token punctuation">:</span> String<span class="token punctuation">,</span> required<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'Name is required'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> timestamps<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&quot;Country&quot;</span><span class="token punctuation">,</span> countrySchema<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><blockquote><blockquote><p><code>models/Country.js</code> - notice how Mongoose pluralisation works, even if it's not as simple as just appending an <code>s</code> to our model name, in order to link the model to a collection.</p></blockquote></blockquote> <h3 id="this-task-is-vital-if-you-get-stuck-simply-copy-my-seeder-code-from-here-and-re-run-your-seeds-npm-run-seeder"><a href="#this-task-is-vital-if-you-get-stuck-simply-copy-my-seeder-code-from-here-and-re-run-your-seeds-npm-run-seeder" aria-hidden="true" class="header-anchor">#</a> This task is vital, if you get stuck - <a href="https://github.com/joeappleton18/db-starter-project/blob/week-7-solutions/seeder.js" target="_blank" rel="noopener noreferrer">simply copy my seeder code from here and re-run your seeds<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <code>npm run seeder</code></h3> <h2 id="defining-relationships"><a href="#defining-relationships" aria-hidden="true" class="header-anchor">#</a> Defining relationships</h2> <p>Now we have set up our further collections we can expand <code>models/Tasting.js</code> schema to express some further relationships.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> tastingSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    country_id<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
      ref<span class="token punctuation">:</span> <span class="token string">&quot;Country&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    province_id<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
      ref<span class="token punctuation">:</span> <span class="token string">&quot;Province&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    taster_id<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      type<span class="token punctuation">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span>
      ref<span class="token punctuation">:</span> <span class="token string">&quot;Taster&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    regions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> type<span class="token punctuation">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> ref<span class="token punctuation">:</span> <span class="token string">&quot;Region&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">...</span> 
<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><blockquote><blockquote><p><code>models/Tasting.js</code>  - Setting up relationships. The observant, may notice that this structure won't work for existing documents in our database. However, for demo sake this is fine. Later, you could always update the seeder to set up these relationships.</p></blockquote></blockquote> <p>Above, notice how we can tell Mongoose that we want to reference a given ID on a third-party document.  Notice how we use the singular collection name - e.g <code>ref: &quot;Region&quot;</code>. Finally, can you see how we have set up a One-to-N relationship with regions -  <code>regions: [{ type: mongoose.Schema.Types.ObjectId, ref: &quot;Region&quot; }]</code>.</p> <h2 id="task-2-defining-relations"><a href="#task-2-defining-relations" aria-hidden="true" class="header-anchor">#</a> Task 2 - Defining Relations</h2> <p>Update the <code>models/Tasting.js</code> schema to relate it to your newly created collections.</p> <h2 id="inserting-related-data"><a href="#inserting-related-data" aria-hidden="true" class="header-anchor">#</a> Inserting Related Data</h2> <p>In order to create a new Tasting a user may connect that tasting with a country, province, region and a taster. We, of course, don't expect the user to type in an associated ID to form this connection (although I have seen some students do things like this üòâ). Rather, we want to allow the user to select from a drop down. Let's focus on countries and consider how we might do this:</p> <p>Notice how I've already created a <code>views/create-tasting.ejs</code>. Let's add a get controller method in <code>controllers/tasting.js</code> that will handle this request:</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">createView</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;create-tasting&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p><code>controllers/tasting.js</code>  - notice how we've used the name createView this is to differentiate this method from create (you can choose a different naming convention)</p></blockquote></blockquote> <p>Next, ensure that you connect the controller method to the route in <code>app.js</code> - <code>app.get(&quot;/create-tasting&quot;, tastingController.createView);</code></p> <p>In order to populate a drop down list of countries we need to use our countries model to find all countries, then we can inject this result in to the view.</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Country <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;../models/Country&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">...</span><span class="token punctuation">.</span>

exports<span class="token punctuation">.</span><span class="token function-variable function">createView</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> countries <span class="token operator">=</span> <span class="token keyword">await</span> Country<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;create-tasting&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      countries<span class="token punctuation">:</span> countries<span class="token punctuation">,</span>
      errors<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">could not generate create data</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">...</span>
</code></pre></div><blockquote><blockquote><p><code>controllers/tasting.js</code> - Injecting a list of countries into our view</p></blockquote></blockquote> <p>We can now simply use the passed in countries data to generate a dropdown for the user:</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-group&quot;</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>label <span class="token keyword">for</span><span class="token operator">=</span><span class="token string">&quot;exampleFormControlSelect1&quot;</span><span class="token operator">&gt;</span>Select Taster<span class="token operator">&lt;</span><span class="token operator">/</span>label<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>select
                  <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;form-control&quot;</span>
                  name<span class="token operator">=</span><span class="token string">&quot;country_id&quot;</span>
                  id<span class="token operator">=</span><span class="token string">&quot;exampleFormControlSelect1&quot;</span>
                <span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">%</span> countries<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span> <span class="token parameter">country</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>option value<span class="token operator">=</span><span class="token string">&quot;&lt;%= country._id %&gt;&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">%=</span> country<span class="token punctuation">.</span>name <span class="token operator">%</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
              <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>         
</code></pre></div><blockquote><blockquote><p><code>controllers/tasting.js</code> - Creating a drop down of countries</p></blockquote></blockquote> <p>Above, we create a drop down of countries. Notice how set the value of each drop down option to <code>country._id</code>. It is this value that gets associated to <code>country_id</code>. However, we display to the user the name of each country.</p> <h2 id="task-3-create-a-tasting"><a href="#task-3-create-a-tasting" aria-hidden="true" class="header-anchor">#</a> Task 3 - Create a Tasting</h2> <p>Update your wine tasting application so users can create a tasting. For now just allow the user to input three items (this is fine for learning, although not overly realistic):</p> <ul><li><code>wine title</code> - free form string</li> <li><code>points</code> - a number **hint, you'll need to convert this to an int using <code>parseInt</code> before you can save it.</li> <li><code>countries</code> - a dropdown list of countries</li></ul> <h2 id="one-to-many-user-input"><a href="#one-to-many-user-input" aria-hidden="true" class="header-anchor">#</a> One-to-Many User Input</h2> <p>Allowing the user to enter One-to-Many relationships is hard to do in an elegant way - without front-end javaScript. For the sake of this module, we can use an HTML check box to facilitate this process. Let's consider how we might allow the user to select multiple regions.</p> <p>First, like we did for our related fields above, we need to get a list of regions and pass it into our view. Next, in our view, we can iterate over regions to generate our check boxes:</p> <div class="language-html extra-class"><pre class="language-html"><code>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-group<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                &lt;% regions.forEach( region =&gt; { %&gt;
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-check form-check-inline<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                &lt;input
                  name=&quot;regions&quot;
                  class=&quot;form-check-input&quot;
                  type=&quot;checkbox&quot;
                  id=&quot;inlineCheckbox2&quot;
                  value= &lt;%= region._id %&gt;
                /&gt;
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-check-label<span class="token punctuation">&quot;</span></span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>inlineCheckbox2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>&lt;%= region.name %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>          

</code></pre></div><p><code>views/create-tasting.ejs</code> - this generates check boxes for users to select regions.</p> <p>The above would embed an array of user selected regions into the HTML post request. We could then save our regions like this:</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> taster <span class="token operator">=</span> <span class="token keyword">await</span> Taster<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>taster_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Tasting<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      title<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
      taster_name<span class="token punctuation">:</span> taster<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
      taster_twitter_handle<span class="token punctuation">:</span> taster<span class="token punctuation">.</span>twitter_handle<span class="token punctuation">,</span>
      points<span class="token punctuation">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>points<span class="token punctuation">)</span><span class="token punctuation">,</span>
      taster_id<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>taster_id<span class="token punctuation">,</span>
      regions<span class="token punctuation">:</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>regions
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/tastings/?message=tasting has been created'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>errors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'create-tasting'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> errors<span class="token punctuation">:</span> e<span class="token punctuation">.</span>errors <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      message<span class="token punctuation">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><blockquote><p><code>controllers/tasting.js</code> - Saving a tasting</p></blockquote></blockquote> <p>Recall, last week, we looked at how to populate form for editing. Populating our checkboxes is a little more involved. Requiring some javaScript trickery:</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-group<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
   
                
                &lt;% regions.forEach( region =&gt; { %&gt;
               <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-check form-check-inline<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span>
                  <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>regions<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-check-input<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>checkbox<span class="token punctuation">&quot;</span></span>
                  <span class="token attr-name">&lt;%</span> <span class="token attr-name">if</span> <span class="token attr-name">(tasting.regions.includes(region._id))</span> <span class="token attr-name">{%</span><span class="token punctuation">&gt;</span></span>   checked &lt;% } %&gt; 
                  id=&quot;inlineCheckbox2&quot;
                  value= &quot;&lt;%= region._id %&gt;&quot;
                /&gt;
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>form-check-label<span class="token punctuation">&quot;</span></span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>inlineCheckbox2<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>&lt;%= region.name %&gt;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
              &lt;% }) %&gt;


</code></pre></div><blockquote><blockquote><p>views/update-tastings.ejs - notice how we optionally render &quot;checked&quot; <code>&lt;% if (tasting.regions.includes(region._id)) {%&gt; checked &lt;% } %&gt;</code>. This checks the checkbox if the given <code>region_id</code> exists in our tasting.region array</p></blockquote></blockquote> <h2 id="task-4-add-regions-to-create-tasting"><a href="#task-4-add-regions-to-create-tasting" aria-hidden="true" class="header-anchor">#</a> Task 4 - Add Regions to Create Tasting</h2> <p>Use the notes above to add regions to <code>views/create-tasting.ejs</code></p> <h2 id="task-5-update-tasting"><a href="#task-5-update-tasting" aria-hidden="true" class="header-anchor">#</a> Task 5 - Update Tasting</h2> <p>Create a <code>update-tasting</code> route and view. The route should allow a <code>:id</code> param of the tasting to be passed in e.g. <code>update-tasting/5faeca10d03f69cbfdb559e5</code>. Just test your code by manually constructing the url.</p> <h2 id="mongoose-aggregation"><a href="#mongoose-aggregation" aria-hidden="true" class="header-anchor">#</a> Mongoose Aggregation</h2> <p>Mongoose exposes MongoDB's aggregation library to us. However, currently we have not  used the idea of aggregation in our application. Our application's home page seems like the perfect candidate. We could use aggregation to gather the following:</p> <ul><li>The total number of reviews (although, it's easier to do <code>Tastings.find({}).count()</code>)</li> <li>The number of different countries</li> <li>The number of different tasters</li> <li>Each taster and their total number of reviews</li></ul> <p>Let's create a <code>controllers/home.js</code> controller and consider how we might handle some of these operations.</p> <div class="language-javaScript extra-class"><pre class="language-javascript"><code>    <span class="token keyword">const</span> Tasting <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/Tasting'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    exports<span class="token punctuation">.</span><span class="token function-variable function">list</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> totalCountries <span class="token operator">=</span> <span class="token keyword">await</span> Tasting<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span> $group<span class="token punctuation">:</span> <span class="token punctuation">{</span> _id<span class="token punctuation">:</span> <span class="token string">&quot;$country&quot;</span><span class="token punctuation">,</span> total<span class="token punctuation">:</span> <span class="token punctuation">{</span> $sum<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> $count<span class="token punctuation">:</span> <span class="token string">&quot;total&quot;</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
      
        <span class="token keyword">const</span> tasterCountSummary <span class="token operator">=</span> tasterCountSummaryRef<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">t</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> t<span class="token punctuation">.</span>_id<span class="token punctuation">,</span> total<span class="token punctuation">:</span> t<span class="token punctuation">.</span>total <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> 
             totalCountries<span class="token punctuation">:</span> totalCountries<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>total <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            message<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">error rendering page</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><blockquote><p><code>controllers/home.js</code> - Above, we access MongoDB's aggregation framework to count the total number of countries and inject that information into our view.</p></blockquote></blockquote> <h2 id="task-6-aggregation-play"><a href="#task-6-aggregation-play" aria-hidden="true" class="header-anchor">#</a> Task 6 - Aggregation Play</h2> <p>Using only our Tasting model (yes, I appreciate this makes things harder),. Can you dynamically generate all of the statistics and summaries on the home page.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/data-management-2021-notes/sessions/week_6_a/" class="prev">Week 6 (Thinking about updating data)</a></span> <span class="next"><a href="/data-management-2021-notes/sessions/week_8/">Week 8 ( User Authentication)</a>‚Üí
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/data-management-2021-notes/assets/js/app.59276b66.js" defer></script><script src="/data-management-2021-notes/assets/js/2.3c4de620.js" defer></script><script src="/data-management-2021-notes/assets/js/13.0b1d5c6c.js" defer></script>
  </body>
</html>
